{% extends "account/base.html" %}
{% load i18n %}
{% load voyage_extras %}

{% block center-content %}
<link rel="stylesheet" href="{{ STATIC_URL }}css/contribute/bootstrap.min.css">
<link rel="stylesheet" href="{{ STATIC_URL }}css/contribute/selectize.bootstrap3.css">
<link rel="stylesheet" href="{{ STATIC_URL }}css/contribute.css">

<h1 class='contribute_header'>{{ contribution }}</h1>

{% if mode == 'contribute' %}
<p>
    {% trans "Variables are organized into eight categories." %}
    {{ contribution.help_text|safe }}
    {% trans "Comments or notes on any entry may be added by clicking on the comment icon to the right of each input box." %}
    {% trans "Should you wish to add a port or region that does not appear in the drop down menu, please let the editors know via the note box at the foot of the entry form." %}
    {% trans "If required, use this box for any additional information." %}
    {% trans "You can review your complete entry at any time by clicking on the 'Review' button. To submit your entry you must move to the Review page first." %}
</p>
{% endif %}

{{ form.errors }}

<form action="{{ request.get_full_path }}" method="post" class="form-horizontal">
    {% csrf_token %}
    <!-- Ship, nation, owners -->
    <div class="expander_container">
        <div>
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#ship_nation_owners" aria-expanded="false" aria-controls="ship_nation_owners">
              <h1>{% trans "Ship, nation, owners" %}</h1>
            </a>
        </div>
        <div id="ship_nation_owners" class="collapse col-md-12 var_group">
        <div class="form-group">
            {% with form.name_of_vessel as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    {{ f }}
                </div>                
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.ship_construction_place as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.ship_registration_place as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.year_ship_constructed as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.year_ship_registered as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.national_carrier as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Nationalities" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.rig_of_vessel as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Rig of vessel" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.tonnage_of_vessel as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.ton_type as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Tonnage type" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.guns_mounted as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.first_ship_owner as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.second_ship_owner as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.additional_ship_owners as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8{% if mode == 'contribute' %} last_group_input{% endif %}">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        
        {% if mode != 'contribute' %}        
        <div class="form-group">
            {% with form.imputed_national_carrier as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Nationalities" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_standardized_tonnage as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_region_ship_constructed as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8 last_group_input">
                    <select class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        {% endif %}
    </div>
    </div>

    <!-- Voyage outcome -->
    <div class="expander_container">
        <div>
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#outcome" aria-expanded="false" aria-controls="outcome">
              <h1>{% trans "Voyage outcome" %}</h1>
            </a>
        </div>
        <div id="outcome" class="collapse col-md-12 var_group">
        <div class="form-group">
            {% with form.voyage_outcome as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Other voyage outcomes" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.african_resistance as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8{% if mode == 'contribute' %} last_group_input{% endif %}">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "African resistance" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        
        {% if mode != 'contribute' %}
        <div class="form-group">
            {% with form.imputed_outcome_of_voyage_for_slaves as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Voyage outcomes for slaves" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_outcome_of_voyage_if_ship_captured as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Voyage outcomes if ship captured" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_outcome_of_voyage_for_owner as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8 last_group_input">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Voyage outcomes for owner" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        {% endif %}
    </div>
    </div>

    <!-- Voyage itinerary -->
    <div class="expander_container">
        <div>
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#itinerary" aria-expanded="false" aria-controls="itinerary">
              <h1>{% trans "Voyage itinerary" %}</h1>
            </a>
        </div>
        <div id="itinerary" class="collapse col-md-12 var_group">
        <div class="form-group">
            {% with form.first_port_intended_embarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.second_port_intended_embarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.first_port_intended_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.second_port_intended_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.port_of_departure as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.number_of_ports_called_prior_to_slave_purchase as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.first_place_of_slave_purchase as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.second_place_of_slave_purchase as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.third_place_of_slave_purchase as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.principal_place_of_slave_purchase as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.place_of_call_before_atlantic_crossing as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.number_of_new_world_ports_called_prior_to_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.first_place_of_landing as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.second_place_of_landing as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.third_place_of_landing as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.principal_place_of_slave_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.port_voyage_ended as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8{% if mode == 'contribute' %} last_group_input{% endif %}">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        {% if mode != 'contribute' %}
        <div class="form-group">
            {% with form.imputed_port_where_voyage_began as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_principal_place_of_slave_purchase as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_principal_port_of_slave_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_region_where_voyage_began as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_region_where_voyage_began as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_first_region_of_slave_landing as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_second_region_of_slave_landing as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_first_region_of_embarkation_of_slaves as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_second_region_of_embarkation_of_slaves as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_third_region_of_embarkation_of_slaves as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8 last_group_input">
                    <input class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        {% endif %}
    </div>
    </div>

    <!-- Voyage dates -->
    <div class="expander_container">
        <div>
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#dates" aria-expanded="false" aria-controls="dates">
                <h1>{% trans "Voyage dates" %}</h1>
            </a>
        </div>
        <div id="dates" class="collapse col-md-12 var_group">
        <p>{% trans "Enter partial information (year only or month and year only) when full date unknown." %}</p>
        <div class="form-group">
            {% with form.date_departure as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input class="date_input" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_slave_purchase_began as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input class="date_input" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_vessel_left_last_slaving_port as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input class="date_input" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_first_slave_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input class="date_input" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_second_slave_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input class="date_input" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_third_slave_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input class="date_input" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_return_departure as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input class="date_input" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_voyage_completed as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input class="date_input" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.length_of_middle_passage as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2{% if mode == 'contribute' %} last_group_input{% endif %}">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        
        {% if mode != 'contribute' %}
        <div class="form-group">
            {% with form.imputed_year_voyage_began as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_year_departed_africa as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_year_arrived_at_port_of_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_quinquennium_in_which_voyage_occurred as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_decade_in_which_voyage_occurred as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_century_in_which_voyage_occurred as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_quarter_century_in_which_voyage_occurred as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_century_in_which_voyage_occurred as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_voyage_length_home_port_to_first_port_of_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_length_of_middle_passage as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2 last_group_input">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        {% endif %}
    </div>
    </div>

    <!-- Captain and crew -->
    <div class="expander_container">
        <div>
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#crew" aria-expanded="false" aria-controls="crew">
              <h1>{% trans "Captain and crew" %}</h1>
            </a>
        </div>
        <div id="crew" class="collapse col-md-12 var_group">
        <div class="form-group">
            {% with form.first_captain as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.second_captain as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.third_captain as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREW1">
                {% trans "Crew at voyage outset" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREW1" name="interim_slave_number_CREW1">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREW2">
                {% trans "Crew at departure from last port of slave purchase" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREW2" name="interim_slave_number_CREW2">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREW3">
                {% trans "Crew at first landing of slaves" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREW3" name="interim_slave_number_CREW3">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREW4">
                {% trans "Crew when return voyage began" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREW4" name="interim_slave_number_CREW4">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREW5">
                {% trans "Crew at end of voyage" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREW5" name="interim_slave_number_CREW5">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREW">
                {% trans "Number of crew if voyage stage unknow" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREW" name="interim_slave_number_CREW">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SAILD1">
                {% trans "Crew died before first place of trade in Africa" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SAILD1" name="interim_slave_number_SAILD1">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SAILD2">
                {% trans "Crew died while ship was on African coast" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SAILD2" name="interim_slave_number_SAILD2">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SAILD3">
                {% trans "Crew died during middle passage" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SAILD3" name="interim_slave_number_SAILD3">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SAILD4">
                {% trans "Crew died in the Americas" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SAILD4" name="interim_slave_number_SAILD4">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SAILD5">
                {% trans "Crew died on return voyage" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SAILD5" name="interim_slave_number_SAILD5">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREWDIED">
                {% trans "Crew died during complete voyage" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREWDIED" name="interim_slave_number_CREWDIED">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_NDESERT">
                {% trans "Total number of crew deserted" %}:
            </label>
            <div class="input-group col-sm-2 last_group_input">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_NDESERT" name="interim_slave_number_NDESERT">
            </div>
        </div>
    </div>
    </div>

    <!-- Slaves (numbers) -->
    <div class="expander_container">
        <div>
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#slave_numbers_main" aria-expanded="false" aria-controls="slave_numbers_main">
              <h1>{% trans "Slaves (numbers)" %}</h1>
            </a>
        </div>
        <div id="slave_numbers_main" class="collapse col-md-12 var_group">
        <div class="form-group">
            <label for="interim_slave_number_SLINTEND">
                {% trans "Slaves intended from first port of purchase" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLINTEND" name="interim_slave_number_SLINTEND">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLINTEN2">
                {% trans "Slaves intended from second port of purchase" %}:
            </label>            
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLINTEN2" name="interim_slave_number_SLINTEN2">
            </div>            
        </div>
        <div class="form-group">
            <label for="interim_slave_number_NCAR13">
                {% trans "Slaves carried from first port of purchase" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_NCAR13" name="interim_slave_number_NCAR13">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_NCAR15">
                {% trans "Slaves carried from second port of purchase" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_NCAR15" name="interim_slave_number_NCAR15">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_NCAR17">
                {% trans "Slaves carried from third port of purchase" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_NCAR17" name="interim_slave_number_NCAR17">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_TSLAVESP">
                {% trans "Total slaves purchased in Africa" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_TSLAVESP" name="interim_slave_number_TSLAVESP">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_TSLAVESD">
                {% trans "Total slaves on board at departure from last slaving port" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_TSLAVESD" name="interim_slave_number_TSLAVESD">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLAARRIV">
                {% trans "Total slaves arrived at first port of disembarkation" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLAARRIV" name="interim_slave_number_SLAARRIV">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLAS32">
                {% trans "Slaves disembarked at first place" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLAS32" name="interim_slave_number_SLAS32">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLAS36">
                {% trans "Slaves disembarked at second place" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLAS36" name="interim_slave_number_SLAS36">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLAS39">
                {% trans "Slaves disembarked at third place" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLAS39" name="interim_slave_number_SLAS39">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLADAFRI">
                {% trans "Slaves deaths before leaving Africa" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLADAFRI" name="interim_slave_number_SLADAFRI">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLADVOY">
                {% trans "Slaves deaths between Africa and the Americas" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLADVOY" name="interim_slave_number_SLADVOY">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLADAMER">
                {% trans "Slaves deaths between arrival and sale" %}:
            </label>
            <div class="input-group col-sm-2{% if mode == 'contribute' %} last_group_input{% endif %}">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLADAMER" name="interim_slave_number_SLADAMER">
            </div>
        </div>
        
        {% if mode != 'contribute' %}
        <div class="form-group">
            {% with form.imputed_voyage_groupings_for_estimating_imputed_slaves as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Voyage groupings" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_total_slaves_embarked as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group last_group_input">
            {% with form.imputed_total_slaves_disembarked as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        {% endif %}
    </div>
    </div>
    
    {% if mode != 'contribute' %}
    <!-- Slaves (mortality and price) -->
    <div class="expander_container">
        <div>
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#mortality_and_price" aria-expanded="false" aria-controls="mortality_and_price">
              <h1>{% trans "Slaves (mortality and price)" %}</h1>
            </a>
        </div>
        <div id="mortality_and_price" class="collapse col-md-12 var_group">
            <div class="form-group">
                {% with form.imputed_number_of_slaves_embarked_for_mortality_calculation as f %}
                    {{ f.errors }}
                    {{ f.label_tag }}
                    <div class="input-group col-sm-2">
                        {{ f }}
                    </div>
                {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
            </div>
            <div class="form-group">
                {% with form.imputed_total_slave_deaths_during_middle_passage as f %}
                    {{ f.errors }}
                    {{ f.label_tag }}
                    <div class="input-group col-sm-2">
                        {{ f }}
                    </div>
                {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
            </div>
            <div class="form-group">
                {% with form.imputed_mortality_rate as f %}
                    {{ f.errors }}
                    {{ f.label_tag }}
                    <div class="input-group col-sm-2">
                        {{ f }}
                    </div>
                {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
            </div>
            <div class="form-group last_group_input">
                {% with form.imputed_standardized_price_of_slaves as f %}
                    {{ f.errors }}
                    {{ f.label_tag }}
                    <div class="input-group col-sm-2">
                        {{ f }}
                    </div>
                {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Slaves (characteristics) -->
    <div class="expander_container">
        <div>
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#demographics" aria-expanded="false" aria-controls="demographics">
              <h1>{% trans "Slaves (characteristics)" %}</h1>
            </a>
        </div>
        <div id="demographics" class="collapse col-md-12 var_group">
        <div id="hidden_div" style="display:none">
            <input type="number" id="cell_editor" style="width: 65px;">
        </div>
        <table id="demographics_table" class="table table-striped" style="width: auto">
            <thead>
                <tr>
                    <th></th>
                    <th>{% trans "Men" %}</th>
                    <th>{% trans "Women" %}</th>
                    <th>{% trans "Boys" %}</th>
                    <th>{% trans "Girls" %}</th>
                    <th>{% trans "Males" %}</th>
                    <th>{% trans "Females" %}</th>
                    <th>{% trans "Adults" %}</th>
                    <th>{% trans "Children" %}</th>
                    <th>{% trans "Infants" %}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>{% trans "Embarked slaves (first port)" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Embarked slaves (second port)" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Embarked slaves (third port)" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Died on voyage" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Disembarked slaves (first port)" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Disembarked slaves (second port)" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                {% if mode != 'contribute' %}
                <tr>
                    <th>{% trans "Imputed number at ports of purchase*" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Imputed number at ports of landing*" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Imputed number at departure or arrival*" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Imputed deaths on middle passage*" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        <div class="form-group">
            <label for="notes_for_slaves_demographics">
                {% trans "Notes for slaves characteristics" %}:
            </label>
            <div class="input-group col-md-8 last_group_input">
                <textarea class="form-control not_selectized field_notes" id="notes_for_slaves_demographics" name="notes_for_slaves_demographics"></textarea>
            </div>
        </div>
    </div>
    </div>
    
    {% if mode != 'contribute' %}
    <!-- Slaves (age and sex) -->
    <div class="expander_container">
        <div>
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#age_and_sex" aria-expanded="false" aria-controls="age_and_sex">
              <h1>{% trans "Slaves (age and sex)" %}</h1>
            </a>
        </div>
        <div id="age_and_sex" class="collapse col-md-12 var_group">
        <table id="age_and_sex_table" class="table table-striped" style="width: auto">
            <thead>
                <tr>
                    <th></th>
                    <th>{% trans "At ports of purchase" %}</th>
                    <th>{% trans "At ports of landing" %}</th>
                    <th>{% trans "At departure or on arrival" %}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>{% trans "Total identified by age*" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Total identified by gender*" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Total identified by age and gender*" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Percentage of men*" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Percentage of women*" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Percentage of boys*" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Percentage of girls*" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Child ratio*" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Male ratio*" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
            </tbody>
        </table>
        </div>
    </div>
    {% endif %}

    <!-- Sources -->
    <div class="expander_container">
        <div>
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#sources" aria-expanded="false" aria-controls="sources">
              <h1>{% trans "Sources" %}</h1>
            </a>
        </div>
        <div id="sources" class="collapse col-md-12 var_group">
        {% if interim.pre_existing_sources.all %}
            <h3>{% trans "Current source references" %}</h3>
            {% trans "Please specify whether the sources below should be included, excluded, or edited." %}
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>{% trans "Voyage ID(s)" %}</th>
                    <th>{% trans "Short reference" %}</th>
                    <th>{% trans "Full reference" %}</th>
                    <th>{% trans "Action" %}</th>
                </tr>
                </thead>
                <tbody>
                {% for source in interim.pre_existing_sources.all %}
                    <tr>
                        <td>{{ source.voyage_ids }}</td>
                        <td>{{ source.original_ref }}</td>
                        <td>{{ source.full_ref|safe }}</td>
                        <td>
                            <div class="dropdown">
                                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span id="pre_source_action_span_{{ source.pk }}" class="glyphicon glyphicon-{% if source.action = 0 %}ok{% endif %}{% if source.action = 1 %}pencil{% endif %}{% if source.action = 2 %}remove{% endif %}"></span>
                                </button>
                                <input type="hidden" id="pre_existing_source_action_{{ source.pk }}" name="pre_existing_source_action_{{ source.pk }}" value="{{ source.action }}">
                                <ul class="dropdown-menu pull-right">
                                <li><a href="" class="pre_source_menu_accept" data-sourcepk="{{ source.pk }}">{% trans "Accept as it is" %}</a></li>
                                <li><a href="" class="pre_source_menu_exclude" data-sourcepk="{{ source.pk }}">{% trans "Exclude reference (please explain)" %}</a></li>
                                <li><a href="" class="pre_source_menu_edit" data-sourcepk="{{ source.pk }}">{% trans "Edit reference (please explain)" %}</a></li>
                                <li role="separator" class="divider"></li>
                                <li style="margin:10px; min-width: 400px;"><label for="pre_existing_source_notes_{{ source.pk }}">Notes:</label><textarea class="form-control not_selectized" name="pre_existing_source_notes_{{ source.pk }}" id="pre_existing_source_notes_{{ source.pk }}" type="text">{{ source.notes|default_if_none:'' }}</textarea></li>
                              </ul>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal" id="add_source_modal_btn">
          {% trans "Add source" %}
        </button>
        <table id="sources_table" style="display:none;" class="table table-striped">
            <thead>
                <tr>
                    <th>{% trans "Type of source" %}</th>
                    <th>{% trans "Details" %}</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    </div>

    <hr />
    <div class="form-group">
        <label for="contribution_main_notes">{% trans "Notes or comments about this contribution:" %}</label>
        <div class="col-sm-8">
            <textarea class="form-control not_selectized" id="contribution_main_notes" name="contribution_main_notes">{{ contribution.notes }}</textarea>
        </div>
    </div>
    <input id="global_notes_input" type="hidden" name="notes" />
    <div class="form-group col-md-12">
        <hr />
        <button class="btn btn-primary" type="button" id="save_btn">{% trans "Save" %}</button>
        {% if mode == 'contribute' %}
        <button class="btn btn-success" type="submit" onclick="submit_val='';">{% trans "Review" %}</button>
        <button class="btn btn-danger" type="submit" name="submit_val" value="delete" id="delete_contrib">{% trans "Cancel contribution" %}</button>
        {% endif %}
        &nbsp;<span id="success_info" class="alert alert-success" style="opacity: 0.0">{% trans "Form saved!" %}</span>
    </div>
    {% if mode == 'review' %}
    <div class="col-md-12">
        <hr />
        <h3>{% trans "Reviewer's decision:" %}</h3>
        <div class="form-group">
            <label for="message_to_editor">
                {% trans "Message to editor" %}:
            </label>
            <div class="col-sm-8">
                <textarea class="form-control not_selectized field_notes" id="message_to_editor" name="message_to_editor"></textarea>
            </div>
        </div>
        <div class="form-group">
            <label for="reviewer_decision">
                {% trans "Decision" %}:
            </label>
            <div class="col-sm-8">
                <select class="form-control not_selectized" id="reviewer_decision">
                    <option>{% trans "Please select..." %}</option>
                    <option value="1">{% trans "Accept" %}</option>
                    <option value="2">{% trans "Reject" %}</option>
                </select>
            </div>
        </div>
        <button class="btn btn-danger" type="submit" id="submit_editor_btn">{% trans "Submit to editor" %}</button>
    </div>
    {% endif %}
    {% if mode == 'editor_review' %}
    {% endif %}
</form>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" >
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">{% trans "Add a source reference" %}</h4>
            </div>
            <div class="modal-body" style="height: 500px; overflow-y: auto;">
                <input type="hidden" name="source_id_field" id="source_id_field" />
                <ul class="nav nav-tabs" role="tablist" id="tab_control">
                    <li data-tab="primary" role="presentation" class="active"><a href="#primary"
                                                                                 aria-controls="primary"
                                                                                 role="tab" data-toggle="tab">
                        {% trans "Primary source" %}</a></li>
                    <li data-tab="article" role="presentation"><a href="#article" aria-controls="article"
                                                                  role="tab" data-toggle="tab">{% trans "Article" %}</a></li>
                    <li data-tab="book" role="presentation"><a href="#book" aria-controls="book" role="tab"
                                                               data-toggle="tab">{% trans "Book" %}</a></li>
                    <li data-tab="other" role="presentation"><a href="#other" aria-controls="other" role="tab"
                                                                data-toggle="tab">{% trans "Other" %}</a></li>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="primary">
                        <div class="form-group">
                            <label for="primary_name">{% trans "Name of library or archive" %}</label>
                            <input class="form-control not_selectized" type="text" id="primary_name">
                        </div>
                        <div class="form-group">
                            <label for="primary_loc">{% trans "Location of library/archive" %}</label>
                            <input class="form-control not_selectized" type="text" id="primary_loc">
                        </div>
                        <div class="form-group">
                            <label for="primary_series">{% trans "Series or collection" %}</label>
                            <input class="form-control not_selectized" type="text" id="primary_series">
                        </div>
                        <div class="form-group">
                            <label for="primary_vol">{% trans "Volume or box or bundle" %}</label>
                            <input class="form-control not_selectized" type="text" id="primary_vol">
                        </div>
                        <div class="form-group">
                            <label for="primary_detail">{% trans "Document detail (page or folio number, and/or date of document)" %}</label>
                            <input class="form-control not_selectized" type="text" id="primary_detail">
                        </div>
                        <div class="form-group">
                            <label for="primary_info">{% trans "Information about source" %}</label>
                            <textarea class="form-control not_selectized" id="primary_info"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="primary_url">{% trans "URLs or digitized image of the source to be submitted wherever possible about source" %}</label>
                            <textarea class="form-control not_selectized" id="primary_url"></textarea>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="article">
                        <div class="form-group">
                            <label for="article_author">{% trans "Author" %}</label>
                            <input class="form-control not_selectized" type="text" id="article_author">
                        </div>
                        <div class="form-group">
                            <label for="article_title">{% trans "Title" %}</label>
                            <input class="form-control not_selectized" type="text" id="article_title">
                        </div>
                        <div class="form-group">
                            <label for="article_journal">{% trans "Journal" %}</label>
                            <input class="form-control not_selectized" type="text" id="article_journal">
                        </div>
                        <div class="form-group">
                            <label for="article_volume">{% trans "Volume number" %}</label>
                            <input class="form-control not_selectized" type="text" id="article_volume">
                        </div>
                        <div class="form-group">
                            <label for="article_year">{% trans "Year" %}</label>
                            <input class="form-control not_selectized" type="text" id="article_year">
                        </div>
                        <div class="form-group">
                            <label for="article_first_page">{% trans "Page numbers" %}</label>
                            <div style="width: 100%; overflow-x: hidden">
                                <input class="form-control form-control-inline col-sm-2 not_selectized" type="text" id="article_first_page" style="width: 35%;">
                                <div style="display: inline; float: left;">&nbsp;-&nbsp;</div>
                                <input class="form-control form-control-inline col-sm-2 not_selectized" type="text" id="article_last_page" style="width: 35%;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="article_info">{% trans "Other information" %}</label>
                            <textarea class="form-control not_selectized" id="article_info"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="article_url">{% trans "URLs or digitized image of the source to be submitted wherever possible about source" %}</label>
                            <textarea class="form-control not_selectized" id="article_url"></textarea>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="book">
                        <div class="form-group">
                            <label for="book_author">{% trans "Author" %}</label>
                            <input class="form-control not_selectized" type="text" id="book_author">
                        </div>
                        <div class="form-group">
                            <label for="book_title">{% trans "Title" %}</label>
                            <input class="form-control not_selectized" type="text" id="book_title">
                        </div>
                        <div class="form-group">
                            <label for="book_publisher">{% trans "Publisher" %}</label>
                            <input class="form-control not_selectized" type="text" id="book_publisher">
                        </div>
                        <div class="form-group">
                            <label for="book_pub_place">{% trans "Place of publication" %}</label>
                            <input class="form-control not_selectized" type="text" id="book_pub_place">
                        </div>
                        <div class="form-group">
                            <label for="book_year">{% trans "Year" %}</label>
                            <input class="form-control not_selectized" type="text" id="book_year">
                        </div>
                        <div class="form-group">
                            <label for="book_first_page">{% trans "Page numbers" %}</label>
                            <div style="width: 100%; overflow-x: hidden">
                                <input class="form-control form-control-inline col-sm-2 not_selectized" type="text" id="book_first_page" style="width: 35%;">
                                <div style="display: inline; float: left;">&nbsp;-&nbsp;</div>
                                <input class="form-control form-control-inline col-sm-2 not_selectized" type="text" id="book_last_page" style="width: 35%;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="book_info">{% trans "Other information" %}</label>
                            <textarea class="form-control not_selectized" id="book_info"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="book_url">{% trans "URLs or digitized image of the source to be submitted wherever possible about source" %}</label>
                            <textarea class="form-control not_selectized" id="book_url"></textarea>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="other">
                        <div class="form-group">
                            <label for="other_title">{% trans "Title" %}</label>
                            <input class="form-control not_selectized" type="text" id="other_title">
                        </div>
                        <div class="form-group">
                            <label for="other_location">{% trans "Location" %}</label>
                            <input class="form-control not_selectized" type="text" id="other_location">
                        </div>
                        <div class="form-group">
                            <label for="other_page">{% trans "Page" %}</label>
                            <input class="form-control not_selectized" type="text" id="other_page">
                        </div>
                        <div class="form-group">
                            <label for="other_info">{% trans "Information about source" %}</label>
                            <textarea class="form-control not_selectized" id="other_info"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="other_url">{% trans "URLs or digitized image of the source to be submitted wherever possible about source" %}</label>
                            <textarea class="form-control not_selectized" id="other_url"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="add_source_btn" type="button" class="btn btn-primary">{% trans "Add" %}</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="{{ STATIC_URL }}scripts/contribute/bootstrap.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}scripts/contribute/selectize.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}scripts/contribute/interim.js"></script>
<script type="text/javascript">
    var submit_val = '';
    // Existing voyage(s) data.
    var voyages = {{ voyages_data|safe }};

    // Keep a source id so that each new source gets a unique identifier.
    var _sourceid = 0;
    var all_source_types = [
        {% if sources_post %}
            {{ sources_post|safe }}
        {% else %}
            {{ interim.primary_sources.all|jsonify }},
            {{ interim.article_sources.all|jsonify }},
            {{ interim.book_sources.all|jsonify }},
            {{ interim.other_sources.all|jsonify }}
        {% endif %}
    ];
    var sources = [];
    for (var i = 0; i < all_source_types.length; ++i) {
        sources = sources.concat($.map(all_source_types[i], function(a) {
            return sourceFactory(a, ++_sourceid);
        }));
    }

    function editSource(id) {
        for (var k = 0; k < sources.length; ++k) {
            if (sources[k].id == id) {
                var s = sources[k];
                s.bindToForm();
                $('.nav-tabs a[href="#' + s.type.split(' ', 1)[0].toLowerCase() + '"]').tab('show');
                $("#add_source_btn").html('{% trans "Save changes"  %}');
                $('#myModal').modal('show');
            }
        }
    }

    // Removes the source from the table and array.
    function removeSource(id) {
        for (var k = 0; k < sources.length; ++k) {
            if (sources[k].id == id) {
                sources.splice(k);
                $("#row_source_" + id).remove();
                if (!sources.length) {
                    $('#sources_table').hide();
                }
                return;
            }
        }
    }

    var getValues = function(name) {
        return getVoyagesValues(voyages, name);
    };

    var selectizeInput = function(input) {
        var values = getValues(input.attr('name'));
        var optgroups = [];
        for (var value in values) {
            var ids = values[value];
            optgroups.push({ id: value, label: getGroupName(ids), $order: -1000 });
        }
        var nodeName = input[0].nodeName.toUpperCase();
        if (values && nodeName == 'INPUT') {
            var options = [];
            var currentValue = input.attr('value') || input.val();
            optgroups.push({ id: 'typed', label: gettext('Typed value')});
            for (var value in values) {
                options.push({ source: value, value: value });
                if (value == currentValue) {
                    currentValue = '';
                }
            }
            if (currentValue != '') {
                options.push({ source: 'typed', value: currentValue });
            }
            input.selectize({
                create: function (x, callback) {
                    callback({ source: 'typed', value: x });
                },
                delimiter: '#%#$', // avoid problems when commas are part of the input text.
                persist: false,
                closeAfterSelect: false,
                options: options,
                labelField: 'value',
                valueField: 'value',
                optgroups: optgroups,
                optgroupField: 'source',
                optgroupLabelField: 'label',
                optgroupValueField: 'id',
                searchField: ['value'],
                selectOnTab: true,
                maxItems: 1,
                plugins: ['optgroup_columns', 'restore_on_backspace']
            });
            if (options.length == 1 && currentValue == '') {
                input.val(options[0].value);
            }
        } else if (nodeName == 'SELECT') {
            var $s = input.selectize({
                optgroupField: 'source',
                selectOnTab: true,
                sortField: [{ field: 'priority' }, { field: 'text' }],
                lockOptgroupOrder: true,
                onInitialize: function() {
                    for (var key in optgroups) {
                        var og = optgroups[key];
                        this.addOptionGroup(og.id, og);
                    }
                    for (var value in values) {
                        var found = -1;
                        var list = this.options;
                        for (var i in list) {
                            if (list[i].value == value) {
                                found = i;
                                break;
                            }
                        }
                        if (found < 0) continue;
                        //this.options[found] = { source: value, value: list[found].value, text: list[found].text };
                        this.options["@fake" + found] = { source: value, value: list[found].value, text: list[found].text };
                    }
                },
            });
        } else {
            addNotesPopup(input.attr('name'), input.parent());
        }
        input.addClass('form-control');
    };

    var regions = {};
    var broad_regions = {};

    $(document).ready(function() {
        $('.form-horizontal .form-group>label').addClass('control-label col-sm-4');

        // Store numbers in an object.
        var numbers = {
        {% for k, v in numbers.items %}
            {% if v %}
                '{{ k }}': {{ v }},
            {% endif %}
        {% endfor %}
        };

        // Set demographic table.
        var demographics_table = demographicsTable(numbers, true, voyages);
        var age_and_sex_table = ageAndSexTable(numbers, true, voyages);

        $('#delete_contrib').click(function(e) {
            if (!confirm('{% trans "The contribution will be deleted. Continue anyway?" %}')) {
                e.preventDefault();
            } else {
                submit_val = 'delete';
            }
        });

        $('input[type=text], input[type=number], select, textarea')
            .not('.select_port')
            .not('.select_region')
            .not('.date_input')
            .not('.not_selectized')
            .each(function () {
                var f = $(this);
                selectizeInput(f);
            }
        );

        // Add group with most common options for select items
        var selectize = $("#id_{{ form.voyage_outcome.html_name }}")[0].selectize;
        selectize.addOptionGroup('most_common', {
            label: '{% trans "Most common outcomes" %}',
            $order: -100,
        });
        var commonIds = [1, 42, 173, 64, 52]
        for (var i in selectize.options) {
            var found = selectize.options[i];
            if (selectize.optgroups[found.source].$order < 0) continue;
            var commonIndex = $.inArray(parseInt(found.value), commonIds);
            if (commonIndex >= 0) {
                selectize.options[i] = { priority: commonIndex, source: 'most_common', value: found.value, text: found.text };
            }
        }

        $.ajax('/contribute/places_ajax', {
            success: function(originalPorts) {
                var regionsList = [];
                for (var i = 0; i < originalPorts.length; ++i) {
                    var item = originalPorts[i];
                    if (item.type == "region") {
                        regions[item.pk] = item;
                        regionsList.push(item);
                    } else if (item.type == "broad_region") {
                        broad_regions[item.pk] = item;
                    }
                    item.source = 'data';
                }
                $(".select_region").each(function() {
                    var self = $(this);
                    self.selectize({
                        maxItems: 1,
                        options: regionsList,
                        labelField: 'region',
                        sortField: 'region',
                        valueField: 'pk',
                        selectOnTab: false,
                    });
                });
                var EXISTING_PREFIX = '@existing_';
                $(".select_port").each(function() {
                    var self = $(this);
                    var ports = originalPorts.slice(0);
                    var values = getValues(self.attr('name'));
                    var optgroups = [ { id: 'data', label: '{% trans 'Ports' %}' } ];
                    for (var value in values) {
                        for (var j = 0; j < ports.length; ++j) {
                            var p = ports[j];
                            if (p.type == 'port' && p.value == value) {
                                // Found the port matching a pre-existing value.
                                var copy = jQuery.extend({}, p);
                                copy.value = EXISTING_PREFIX + copy.value;
                                copy.type = 'existing';
                                copy.source = getGroupName(values[value]);
                                copy.order = 0;
                                optgroups.push({ id: copy.source, label: copy.source });
                                ports.unshift(copy);
                                break;
                            }
                        }
                    }
                    var portItemDisplay = function(data, escape) {
                        var region = regions[data.parent];
                        var broad_region = broad_regions[region.parent];
                        return '<div><span class="geo_complement">' + broad_region.broad_region + ' &raquo; ' + region.region + ' &raquo; </span>' + escape(data.port) + '</div>';
                    };
                    self.selectize({
                        maxItems: 1,
                        options: ports,
                        optgroups: optgroups,
                        optgroupField: 'source',
                        optgroupLabelField: 'label',
                        optgroupValueField: 'id',
                        valueField: 'value',
                        searchField: ['port', 'region', 'broad_region'],
                        selectOnTab: false,
                        sortField: 'order',
                        render: {
                            option: function(data, escape) {
                                if (data.type == 'port') {
                                    return '<div class="port region_' + data.parent + '">' + escape(data.port) + '</div>';
                                }
                                if (data.type == 'region') {
                                    return '<div id="r_' + data.pk + '" data-pk="' + data.pk + '" class="mouse_transparent tree_collapsed region broad_region_' + data.parent + '">' + escape(data.region) + '</div>';
                                }
                                if (data.type == 'existing') {
                                    return portItemDisplay(data, escape);
                                }
                                return '<div id="br_' + data.pk + '" data-pk="' + data.pk + '" class="mouse_transparent broad_region tree_collapsed">' + escape(data.broad_region) + '</div>';
                            },
                            item: portItemDisplay,
                        }
                    });
                    self.change(function() {
                        var value = self.val();
                        if ($.type(value) === 'string' && value.startsWith(EXISTING_PREFIX)) {
                            self.val(value.substring(EXISTING_PREFIX.length));
                        }
                    });
                });
            }
        });

        // Handle dates.
        var dateOptions = [];
        for (var i = 1500; i <= 1867; ++i) {
            dateOptions.push({ type: 'year', label: i, value: 'y' + i, search: i });
        }

        {% get_current_language as LANGUAGE_CODE %}
        var locale = "{{ LANGUAGE_CODE }}";
        var getMonthName = function(i) {
            return getMonthLocaleName(locale, i);
        };
        var leadingZero = function(d) {
            return d < 10 ? '0' + d : '' + d;
        };
        for (var i = 1; i <= 12; ++i) {
            var month = getMonthName(i);
            dateOptions.push({ type: 'month', label: month, value: 'm' + leadingZero(i), search: month + ' (' + leadingZero(i) + ')' });
        }
        for (var i = 1; i <= 31; ++i) {
            dateOptions.push({ type: 'day', label: (i < 10 ? '0' : '') + i, value: 'd' + leadingZero(i), search: leadingZero(i) });
        }
        $(".date_input").each(function() {
            var self = $(this);
            var optgroups = [
                { type: 'year', name: '{% trans "Year in the range" %} 1500 - 1867'},
                { type: 'month', name: '{% trans "Month" %}'},
                { type: 'day', name: '{% trans "Day" %}'},
            ];
            var values = getValues(self.attr('name'));
            var options = dateOptions.slice(0);
            var existing = {};
            for (var value in values) {
                if (value == ',,') continue;
                // Parse value in MM,DD,YYYY format.
                var parse = value.split(',');
                if (parse.length != 3) continue;
                parse[0] = parseInt(parse[0]);
                parse[1] = parseInt(parse[1]);
                parse[2] = parseInt(parse[2]);
                var label = '';
                if (parse[2] != '' && !isNaN(parse[2])) label += parse[2];
                if (parse[0] != '' && !isNaN(parse[0])) label += ', ' + getMonthName(parse[0]);
                if (parse[1] != '' && !isNaN(parse[1])) label += ', ' + parse[1];
                var item = { type: value, label: label, value: 'full_' + value, year: parse[2], month: parse[0], day: parse[1] };
                existing[item.value] = item;
                options.unshift(item);
                optgroups.unshift({ type: value, name: getGroupName(values[value]) });
            }
            var current_value = self.attr('value');
            var parse = current_value.split(',');
            current_value = '';
            if (parse.length == 3) {
                var valid = []
                if (parse[2] != '' && !isNaN(parse[2])) valid.push('y' + parse[2]);
                if (parse[0] != '' && !isNaN(parse[0])) valid.push('m' + leadingZero(parse[0]));
                if (parse[1] != '' && !isNaN(parse[1])) valid.push('d' + leadingZero(parse[1]));
                current_value = valid.join(',');
            }
            self.val(current_value);
            self.selectize({
                options: options,
                maxItems: 3,
                searchField: ['search'],
                selectOnTab: false,
                valueField: 'value',
                labelField: 'label',
                optgroupLabelField: 'name',
                optgroupValueField: 'type',
                optgroupField: 'type',
                optgroups: optgroups,
                render: {
                    option: function(data, escape) {
                        if (data.type == 'year') {
                            return '<div class="selectize_year">' + escape(data.label) + '</div>';
                        }
                        if (data.type == 'month') {
                            return '<div class="selectize_month">' + escape(data.search) + '</div>';
                        }
                        if (data.type == 'day') {
                            return '<div class="selectize_day">' + escape(data.label) + '</div>';
                        }
                        return '<div class="selectize_full">' + escape(data.label) + '&nbsp;</div>';
                    },
                },
                score: function(search) {
                    var score = this.getScoreFunction(search);
                    var current = $.map(self[0].selectize.items, function(s) { return s[0]; });
                    return function(item) {
                        var stype = item.type[0];
                        // If not expected type omit result.
                        var allowed = 'y';
                        if (current.indexOf('y') >= 0) {
                            allowed = 'm';
                            if (current.indexOf('m') >= 0) {
                                 allowed = current.indexOf('d') >= 0 ? '' : 'd';
                            }
                        }
                        if (stype != allowed) return 0.0;
                        if (stype == 'd' && search.length == 1) return score(item) * (parseInt(item.label) < 10 ? 5 : 1);
                        return stype == 'y' && search.length != 4 ? 0.0 : score(item);
                    };
                },
            });
            var inside = false;
            var selectize = this.selectize;
            var originalKeyDown = selectize.onKeyDown;
            selectize.onKeyDown = function(e) {
                // Treat tab, space, slash, dash as a RETURN.
                if (e.keyCode == 109 || e.keyCode == 111 || e.keyCode == 32 || e.keyCode == 9) {
                    e.keyCode = 13;
                }
                return originalKeyDown.call(selectize, e);  
            };
            selectize.on('item_add', function(value, item) {
                if (inside) return;
                if (value.startsWith('full')) {
                    this.clear();
                    inside = true;
                    var data = existing[value];
                    if (data.year) this.addItem('y' + data.year);
                    if (data.month) this.addItem('m' + leadingZero(data.month));
                    if (data.day) this.addItem('d' + leadingZero(data.day));
                    inside = false;
                    return;
                }
                // See if there is an item with the same type already selected,
                // if so, delete the item so only the new entry is kept.
                var type = value.charAt(0);
                for (var i = 0; i < this.items.length; ++i) {
                    var val = this.items[i];
                    if (val.charAt(0) == type && val != value) {
                        this.removeItem(val);
                        break;
                    }
                }
                var clone = this.items.slice(0).sort();
                // Place the items in the appropriate order:
                for (var i = clone.length - 1; i >= 0; --i) {
                    var val = clone[i];
                    this.removeItem(val);
                }
                inside = true;
                for (var i = clone.length - 1; i >= 0; --i) {
                    var val = clone[i];
                    this.addItem(val);
                }
                inside = false;
            });
        });

        // Parse notes.
        var NOTES_PREFIX = 'notes_for_';
        {% if form.notes.value %}
            var notes = {{ form.notes.value|safe }}
            for (var key in notes) {
                $('#' + NOTES_PREFIX + key).val(notes[key]).change();
            }
        {% endif %}

        // Highlight labels of fields with pre-existing values:
        for (var id in voyages) {
            var v = voyages[id];
            for (var name in v) {
                if (v[name] != null && v[name] != ',,') {
                    var prefix = name.startsWith(NUMBERS_KEY_PREFIX) ? '' : 'id_';
                    $('label[for="' + prefix + name + '"]').addClass('has_pre_existing_values');
                }
            }
        }

        $('.last_group_input, .last_group_input input, .last_group_input select, .last_group_input textarea').keydown(function(e) {
            if (e.keyCode == KEY_TAB) {
                e.preventDefault();
                e.stopPropagation();
                var $expander = $(this).closest('.expander_container').next().find('.collapse');
                $expander.collapse('show');
                if ($expander.attr('id') == 'demographics') {
                    demographics_table.focus();
                } else if ($expander.attr('id') == 'age_and_sex') {
                    age_and_sex_table.focus();
                } else {
                    $expander.find(':input:visible:enabled:first').focus();
                }
            }
        });

        var addSourceToTable = function(source, isEdit) {
            if (isEdit) removeSource(source.id);
            $('#sources_table > tbody:last-child').append('<tr id="row_source_' + source.id + '"><td>' + source.type + '</td><td>' + source.toString() + '</td><td><a href="#" onclick="editSource(' + source.id + '); return false;">Edit</a></td><td><a href="#" onclick="removeSource(' + source.id + '); return false;">X</a></td></tr>');
            $('#sources_table').show();
        };

        $("#add_source_modal_btn").click(function () {
            $("#myModal input, #myModal textarea").val('');
            var id = ++_sourceid;
            $("#source_id_field").val(id);
            $("#add_source_btn").html('{% trans "Add"  %}');
        });

        $("#add_source_btn").click(function () {
            var type = $("ul#tab_control li.active").data("tab");
            $('#sources_table').show();
            var source = null;
            if (type == 'primary') {
                source = new PrimarySource();
            } else if (type == 'article') {
                source = new ArticleSource();
            } else if (type == 'book') {
                source = new BookSource();
            } else if (type == 'other') {
                source = new OtherSource();
            }
            if (source) {
                source.bindFromForm();
                var validation = source.validate();
                if (validation.hasErrors()) {
                    alert(validation.toString());
                    return false;
                } else if (!validation.hasWarnings() ||
                        confirm(validation.toString() + "\n" + gettext('Continue anyway?'))) {
                    addSourceToTable(source, true);
                    sources.push(source);
                    $('#myModal').modal('hide');
                }
            }
        });

        for (var i = 0; i < sources.length; ++i) {
            addSourceToTable(sources[i]);
        }
        if (sources.length) {
            $('#sources_table').show();
        }

        var sourceIcons = ['ok', 'pencil', 'remove'];
        var sourceMenu = function (src, action) {
            var pk = $(src).data('sourcepk');
            var span = $('#pre_source_action_span_' + pk);
            span.removeClass();
            span.addClass("glyphicon glyphicon-" + sourceIcons[action]);
            $('#pre_existing_source_action_' + pk).val(action);
            if (action > 0) {
                $('#pre_existing_source_notes_' + pk).focus();
            }
            return false;
        };

        $('.pre_source_menu_accept').click(function (e) {
            return sourceMenu(this, 0);
        });
        $('.pre_source_menu_edit').click(function (e) {
            return sourceMenu(this, 1);
        });
        $('.pre_source_menu_exclude').click(function (e) {
            return sourceMenu(this, 2);
        });
        
        var formSubmission = function() {
            if (submit_val != 'delete') {
                // Build pre-existing sources list.
                var preSources = $.map(
                    [{% for source in interim.pre_existing_sources.all %}{{ source.pk }}{% if not forloop.last %},{% endif %}{% endfor %}],
                    function(pk, i) {
                        return {
                            'pk': pk,
                            'action': parseInt($('#pre_existing_source_action_' + pk).val()),
                            'notes': $('#pre_existing_source_notes_' + pk).val()
                        };
                    }
                );
                var validation = validatePreSubmit(sources, preSources);
                if (validation.hasErrors()) {
                    alert(validation.toString());
                    return false;
                } else if (validation.hasWarnings() &&
                        !confirm(validation.toString() + "\n" + gettext('Do you want to submit this voyage anyway?'))) {
                    return false;
                }
            }
            $("input[name^='date']").each(function() {
                var self = $(this);
                // Convert date to the expected format MM,DD,YYYY
                var date = parseDateValue(self.val());
                self.val(date.toMMDDYYY());
            });
            // Send notes.
            var notes_submit = {};
            var prefix_length = NOTES_PREFIX.length;
            $.map($(".field_notes"), function(note, i) {
                var $note = $(note);
                var note_val = $note.val();
                if (note_val != '') {
                    notes_submit[$note.attr('name').substring(prefix_length)] = note_val;
                }
            });
            $("#global_notes_input").val(JSON.stringify(notes_submit));
            // Remove previously appended fields.
            $('.' + APPENDED_FIELD_CLASS).remove();
            var form = $('form');
            // Append demographics matrix.
            demographics_table.appendToForm(form);
            {% if mode != 'contribute' %}
            age_and_sex_table.appendToForm(form);
            {% endif %}
            var $sources = $('<input class="' + APPENDED_FIELD_CLASS + '" type="hidden" name="sources" />');
            var source_models = $.map(sources, function(s, i) {
                return s.toModel();
            });
            $sources.val(JSON.stringify(source_models));
            form.append($sources);
            return true;
        };

        $('form').submit(formSubmission);
        
        var saveAjax = function(success, complete) {
            var $form = $('form');
            $.ajax({
                type: "POST",
                url: '{{ request.get_full_path }}' + '/save_ajax/',
                data: $form.serialize(),
                success: function (response) {
                    var $success = $('#success_info');
                    $success.css('opacity', 1.0);
                    $success.animate({
                            opacity: 0.0
                        },
                        5000
                    );
                    if (success) success();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert('Error saving: ' + textStatus);
                },
                complete: function() {
                    $('#save_btn').prop('disabled', false);
                    if (complete) complete();
                }
            });
        };
        
        // Ajax save.
        $('#save_btn').click(function() {
            var valid = formSubmission();
            if (valid) {
                $(this).prop('disabled', true);
                saveAjax();
            }
        });
        {% if mode == 'review' %}
            $('#submit_editor_btn').click(function() {
                var decision = parseInt($('#reviewer_decision option:selected').val());
                if (decision != 1 && decision != 2) {
                    alert('{% trans "Please choose your decision." %}');
                    return false;
                }
                var message_to_editor = $('#message_to_editor').val().trim();
                if (!confirm('{% trans "Please confirm your message and decision." %}\n{% trans "Decision" %}: ' + $('#reviewer_decision option:selected').text() + '\n' + message_to_editor)) {
                    return false;
                }
                var self = $(this);
                var complete = function() {
                    self.prop('disabled', false);
                };
                self.prop('disabled', true);
                var success = function() {
                    self.prop('disabled', true);              
                    $.ajax({
                        type: "POST",
                        url: '{{ request.get_full_path }}' + '/submit_review_to_editor/',
                        data: {reviewer_decision: decision, message_to_editor: message_to_editor},
                        success: function (response) {
                            window.location.replace("{% url 'contribute:index' %}");
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert('Error sending decision: ' + textStatus);
                        },
                        complete: complete
                    });
                };
                saveAjax(success, complete);
                return false;
            });
        {% endif %}
    });

    // Special handling of port/region/broad region selection.
    var protoSelectOption = Selectize.prototype.onOptionSelect;
    Selectize.prototype.onOptionSelect = function(e) {
        if (this.$input.hasClass('select_port') && e && e.currentTarget) {
			if (e.preventDefault) {
			    e.preventDefault();
			    e.stopPropagation();
			}
            if (e.type && e.type == 'mousedown') return false;
            var target = $(e.currentTarget);
            var className = "expanded";
            if (this.$control_input.val() != '' && !this.options.create) {
                // Clear search if user selected an option.
                id = target.attr('id');
                this.$control_input.val('');
                this.refreshOptions();
                if (id) {
                    target = $("#" + id);
                }
            }
            var nextActive = null;
            if (target.hasClass("broad_region")) {
                nextActive = ".broad_region_" + target.data('pk');
                var isExpanded = $(nextActive + ":first").hasClass(className);
                $(".broad_region,.region,.port").removeClass(className);
                $(".tree_expanded").removeClass('tree_expanded').addClass("tree_collapsed");
                if (isExpanded) return false;
                target.removeClass("tree_collapsed").addClass("tree_expanded").addClass(className);
                $(".broad_region_" + target.data('pk')).addClass(className);
                this.setTextboxValue('');
            } else if (target.hasClass("region")) {
                nextActive = ".region_" + target.data('pk');
                var isExpanded = $(nextActive + ":first").hasClass(className);
                $(".port").removeClass(className);
                $(".region.tree_expanded").removeClass('tree_expanded').addClass("tree_collapsed");
                if (isExpanded) return false;
                target.removeClass("tree_collapsed").addClass("tree_expanded").addClass(className);;
                $(".region_" + target.data('pk')).addClass(className);
                this.setTextboxValue('');
            } else {
                protoSelectOption.apply(this, arguments);
            }
            var activateOption = function(opt) {
                self.setActiveOption($(opt[0]), true, false);
            };
            if (nextActive) {
                var self = this;
                activateOption(self.$dropdown_content.find(nextActive + ":last"));
                activateOption(target);
                activateOption(self.$dropdown_content.find(nextActive + ":first"));
            }
        } else {
            protoSelectOption.apply(this, arguments);
        }
    };
    // TODO: remove this code once styling is done.
    $("#center-content").css('width', '900px');
</script>
{% endblock %}