{% extends "account/base.html" %}
{% load i18n %}
{% load l10n %}
{% load sass_tags %}
{% load voyage_extras %}

{% block center-content %}
<link rel="stylesheet" href="{{ STATIC_URL }}css/contribute/selectize.bootstrap3.css">
<link href="{% sass_src 'scss/contribute.scss' %}" rel="stylesheet" type="text/css" />

<style>
    #return_btn {
        display: inline;
    }

    .label-table {
        table-layout: fixed;
    }

    .pre-value-cell {
        cursor: pointer;
        padding: 3px;
    }

    .pre-value-cell:hover {
        background-color: lightblue;
    }
</style>
<div class="page-title-1" class='contribute_header'>{{ contribution | title }}</div>

{% if mode == 'contribute' %}
<p>
    {% trans "Variables are organized into eight categories." %}
    {{ contribution.help_text|safe }}
    {% trans "Comments or notes on any entry may be added by clicking on the comment icon to the right of each input box." %}
    {% trans "Should you wish to add a port or region that does not appear in the drop down menu, please let the editors know via the note box at the foot of the entry form." %}
    {% trans "If required, use this box for any additional information." %}
    {% trans "You can review your complete entry at any time by clicking on the 'Review' button. To submit your entry you must move to the Review page first." %}
</p>
{% endif %}

{% if contribution.get_related_voyage_ids %}
    <h3>{% trans "Voyage ID(s): " %}
    {% for id in contribution.get_related_voyage_ids %}
        {{ id }}
        {% if not forloop.last %}, {% endif %}
    {% endfor %}
    </h3>
{% endif %}

{{ form.errors }}

<form action="{{ request.path }}" method="post" class="form-horizontal" id="main_form">
    {% csrf_token %}
    <!-- Ship, nation, owners -->
    <div class="expander_container">
        <div>
            <div class="page-title-2">
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#ship_nation_owners" aria-expanded="false" aria-controls="ship_nation_owners">
              {% trans "Ship, Nation, Owners" %}
            </a>
            </div>
        </div>
        <div id="ship_nation_owners" class="collapse col-md-12 var_group">
        <div class="form-group">
            {% with form.name_of_vessel as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.ship_construction_place as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.ship_registration_place as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.year_ship_constructed as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.year_ship_registered as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.national_carrier as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Nationalities" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.rig_of_vessel as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Rig of vessel" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.tonnage_of_vessel as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.ton_type as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Tonnage type" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.guns_mounted as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.first_ship_owner as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.second_ship_owner as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.additional_ship_owners as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8{% if mode == 'contribute' %} last_group_input{% endif %}">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>

        {% if mode == 'editorial_review' %}
        <div class="form-group">
            {% with form.imputed_national_carrier as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Nationalities" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_standardized_tonnage as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_region_ship_constructed as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8 last_group_input">
                    <select class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        {% endif %}
    </div>
    </div>

    <!-- Voyage outcome -->
    <div class="expander_container">
        <div>
            <div class="page-title-2">
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#outcome" aria-expanded="false" aria-controls="outcome">
              {% trans "Voyage Outcome" %}
            </a>
            </div>
        </div>
        <div id="outcome" class="collapse col-md-12 var_group">
        <div class="form-group">
            {% with form.voyage_outcome as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Other voyage outcomes" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.african_resistance as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8{% if mode == 'contribute' %} last_group_input{% endif %}">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "African resistance" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>

        {% if mode == 'editorial_review' %}
        <div class="form-group">
            {% with form.imputed_outcome_of_voyage_for_slaves as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Voyage outcomes for slaves" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_outcome_of_voyage_if_ship_captured as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Voyage outcomes if ship captured" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_outcome_of_voyage_for_owner as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8 last_group_input">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Voyage outcomes for owner" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        {% endif %}
    </div>
    </div>

    <!-- Voyage itinerary -->
    <div class="expander_container">
        <div>
            <div class="page-title-2">
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#itinerary" aria-expanded="false" aria-controls="itinerary">
              {% trans "Voyage Itinerary" %}
            </a>
            </div>
        </div>
        <div id="itinerary" class="collapse col-md-12 var_group">
        <div class="form-group">
            {% with form.first_port_intended_embarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.second_port_intended_embarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.first_port_intended_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.second_port_intended_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.port_of_departure as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.number_of_ports_called_prior_to_slave_purchase as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.first_place_of_slave_purchase as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.second_place_of_slave_purchase as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.third_place_of_slave_purchase as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.principal_place_of_slave_purchase as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.place_of_call_before_atlantic_crossing as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.number_of_new_world_ports_called_prior_to_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.first_place_of_landing as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.second_place_of_landing as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.third_place_of_landing as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.principal_place_of_slave_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.port_voyage_ended as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8{% if mode == 'contribute' %} last_group_input{% endif %}">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        {% if mode == 'editorial_review' %}
        <div class="form-group">
            {% with form.imputed_port_where_voyage_began as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_principal_place_of_slave_purchase as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_principal_port_of_slave_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_port" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_region_where_voyage_began as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_first_region_of_slave_landing as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_second_region_of_slave_landing as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_first_region_of_embarkation_of_slaves as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_second_region_of_embarkation_of_slaves as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <input class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_third_region_of_embarkation_of_slaves as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8 last_group_input">
                    <input class="select_region" id="id_{{ f.html_name }}" name="{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        {% endif %}
    </div>
    </div>

    <!-- Voyage dates -->
    <div class="expander_container">
        <div>
            <div class="page-title-2">
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#dates" aria-expanded="false" aria-controls="dates">
                {% trans "Voyage Dates" %}
            </a>
            </div>
        </div>
        <div id="dates" class="collapse col-md-12 var_group">
        <p>{% trans "Enter partial information (year only or month and year only) when full date unknown." %}</p>
        <div class="form-group">
            {% with form.date_departure as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input type="hidden" name="{{ f.html_name }}" value="{{ f.value }}">
                    <input class="date_input" id="id_{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_slave_purchase_began as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input type="hidden" name="{{ f.html_name }}" value="{{ f.value }}">
                    <input class="date_input" id="id_{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_vessel_left_last_slaving_port as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input type="hidden" name="{{ f.html_name }}" value="{{ f.value }}">
                    <input class="date_input" id="id_{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_first_slave_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input type="hidden" name="{{ f.html_name }}" value="{{ f.value }}">
                    <input class="date_input" id="id_{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_second_slave_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input type="hidden" name="{{ f.html_name }}" value="{{ f.value }}">
                    <input class="date_input" id="id_{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_third_slave_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input type="hidden" name="{{ f.html_name }}" value="{{ f.value }}">
                    <input class="date_input" id="id_{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_return_departure as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input type="hidden" name="{{ f.html_name }}" value="{{ f.value }}">
                    <input class="date_input" id="id_{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.date_voyage_completed as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-3">
                    <input type="hidden" name="{{ f.html_name }}" value="{{ f.value }}">
                    <input class="date_input" id="id_{{ f.html_name }}" value="{{ f.value }}">
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.length_of_middle_passage as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2{% if mode == 'contribute' %} last_group_input{% endif %}">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>

        {% if mode == 'editorial_review' %}
        <div class="form-group">
            {% with form.imputed_year_voyage_began as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_year_departed_africa as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_year_arrived_at_port_of_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_quinquennium_in_which_voyage_occurred as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2 year_range" data-yearmod="5">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_decade_in_which_voyage_occurred as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2 year_range" data-yearmod="10">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_quarter_century_in_which_voyage_occurred as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2 year_range" data-yearmod="25">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_century_in_which_voyage_occurred as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_voyage_length_home_port_to_first_port_of_disembarkation as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_length_of_middle_passage as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2 last_group_input">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        {% endif %}
    </div>
    </div>

    <!-- Captain and crew -->
    <div class="expander_container">
        <div>
            <div class="page-title-2">
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#crew" aria-expanded="false" aria-controls="crew">
              {% trans "Captain and Crew" %}
            </a>
            </div>
        </div>
        <div id="crew" class="collapse col-md-12 var_group">
        <div class="form-group">
            {% with form.first_captain as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.second_captain as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.third_captain as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREW1">
                {% trans "Crew at voyage outset" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREW1" name="interim_slave_number_CREW1">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREW2">
                {% trans "Crew at departure from last port of slave purchase" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREW2" name="interim_slave_number_CREW2">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREW3">
                {% trans "Crew at first landing of slaves" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREW3" name="interim_slave_number_CREW3">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREW4">
                {% trans "Crew when return voyage began" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREW4" name="interim_slave_number_CREW4">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREW5">
                {% trans "Crew at end of voyage" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREW5" name="interim_slave_number_CREW5">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREW">
                {% trans "Number of crew if voyage stage unknow" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREW" name="interim_slave_number_CREW">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SAILD1">
                {% trans "Crew died before first place of trade in Africa" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SAILD1" name="interim_slave_number_SAILD1">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SAILD2">
                {% trans "Crew died while ship was on African coast" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SAILD2" name="interim_slave_number_SAILD2">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SAILD3">
                {% trans "Crew died during middle passage" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SAILD3" name="interim_slave_number_SAILD3">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SAILD4">
                {% trans "Crew died in the Americas" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SAILD4" name="interim_slave_number_SAILD4">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SAILD5">
                {% trans "Crew died on return voyage" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SAILD5" name="interim_slave_number_SAILD5">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_CREWDIED">
                {% trans "Crew died during complete voyage" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_CREWDIED" name="interim_slave_number_CREWDIED">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_NDESERT">
                {% trans "Total number of crew deserted" %}:
            </label>
            <div class="input-group col-sm-2 last_group_input">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_NDESERT" name="interim_slave_number_NDESERT">
            </div>
        </div>
    </div>
    </div>

    <!-- Slaves (numbers) -->
    <div class="expander_container">
        <div>
            <div class="page-title-2">
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#slave_numbers_main" aria-expanded="false" aria-controls="slave_numbers_main">
              {% trans "Slaves (numbers)" %}
            </a>
            </div>
        </div>
        <div id="slave_numbers_main" class="collapse col-md-12 var_group">
        <div class="form-group">
            <label for="interim_slave_number_SLINTEND">
                {% trans "Slaves intended from first port of purchase" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLINTEND" name="interim_slave_number_SLINTEND">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLINTEN2">
                {% trans "Slaves intended from second port of purchase" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLINTEN2" name="interim_slave_number_SLINTEN2">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_NCAR13">
                {% trans "Slaves carried from first port of purchase" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_NCAR13" name="interim_slave_number_NCAR13">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_NCAR15">
                {% trans "Slaves carried from second port of purchase" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_NCAR15" name="interim_slave_number_NCAR15">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_NCAR17">
                {% trans "Slaves carried from third port of purchase" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_NCAR17" name="interim_slave_number_NCAR17">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_TSLAVESP">
                {% trans "Total slaves purchased in Africa" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_TSLAVESP" name="interim_slave_number_TSLAVESP">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_TSLAVESD">
                {% trans "Total slaves on board at departure from last slaving port" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_TSLAVESD" name="interim_slave_number_TSLAVESD">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLAARRIV">
                {% trans "Total slaves arrived at first port of disembarkation" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLAARRIV" name="interim_slave_number_SLAARRIV">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLAS32">
                {% trans "Slaves disembarked at first place" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLAS32" name="interim_slave_number_SLAS32">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLAS36">
                {% trans "Slaves disembarked at second place" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLAS36" name="interim_slave_number_SLAS36">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLAS39">
                {% trans "Slaves disembarked at third place" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLAS39" name="interim_slave_number_SLAS39">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLADAFRI">
                {% trans "Slaves deaths before leaving Africa" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLADAFRI" name="interim_slave_number_SLADAFRI">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLADVOY">
                {% trans "Slaves deaths between Africa and the Americas" %}:
            </label>
            <div class="input-group col-sm-2">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLADVOY" name="interim_slave_number_SLADVOY">
            </div>
        </div>
        <div class="form-group">
            <label for="interim_slave_number_SLADAMER">
                {% trans "Slaves deaths between arrival and sale" %}:
            </label>
            <div class="input-group col-sm-2{% if mode == 'contribute' %} last_group_input{% endif %}">
                <input type="number" class="form-control slave_number_field" id="interim_slave_number_SLADAMER" name="interim_slave_number_SLADAMER">
            </div>
        </div>

        {% if mode == 'editorial_review' %}
        <div class="form-group">
            {% with form.imputed_voyage_groupings_for_estimating_imputed_slaves as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-8">
                    <select id="id_{{ f.html_name }}" name="{{ f.html_name }}">
                        <option value=""></option>
                        <optgroup label='{% trans "Voyage groupings" %}'>
                            {% for val,text in f.field.choices %}
                                {% if val != '' %}
                                    <option value="{{ val }}"{% if f.value == val %} selected{% endif %}>{{ text }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group">
            {% with form.imputed_total_slaves_embarked as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        <div class="form-group last_group_input">
            {% with form.imputed_total_slaves_disembarked as f %}
                {{ f.errors }}
                {{ f.label_tag }}
                <div class="input-group col-sm-2">
                    {{ f }}
                </div>
            {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
        </div>
        {% endif %}
    </div>
    </div>

    {% if mode == 'editorial_review' %}
    <!-- Slaves (mortality and price) -->
    <div class="expander_container">
        <div>
            <div class="page-title-2">
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#mortality_and_price" aria-expanded="false" aria-controls="mortality_and_price">
              {% trans "Slaves (mortality and price)" %}
            </a>
            </div>
        </div>
        <div id="mortality_and_price" class="collapse col-md-12 var_group">
            <div class="form-group">
                {% with form.imputed_number_of_slaves_embarked_for_mortality_calculation as f %}
                    {{ f.errors }}
                    {{ f.label_tag }}
                    <div class="input-group col-sm-2">
                        {{ f }}
                    </div>
                {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
            </div>
            <div class="form-group">
                {% with form.imputed_total_slave_deaths_during_middle_passage as f %}
                    {{ f.errors }}
                    {{ f.label_tag }}
                    <div class="input-group col-sm-2">
                        {{ f }}
                    </div>
                {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
            </div>
            <div class="form-group">
                {% with form.imputed_mortality_rate as f %}
                    {{ f.errors }}
                    {{ f.label_tag }}
                    <div class="input-group col-sm-2">
                        {{ f }}
                    </div>
                {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
            </div>
            <div class="form-group last_group_input">
                {% with form.imputed_standardized_price_of_slaves as f %}
                    {{ f.errors }}
                    {{ f.label_tag }}
                    <div class="input-group col-sm-2">
                        {{ f }}
                    </div>
                {% if f.help_text %}<p class="form_help_text">{{ f.help_text }}</p>{% endif %}{% endwith %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Slaves (characteristics) -->
    <div class="expander_container">
        <div>
            <div class="page-title-2">
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#demographics" aria-expanded="false" aria-controls="demographics">
              {% trans "Slaves (characteristics)" %}
            </a>
            </div>
        </div>
        <div id="demographics" class="collapse col-md-12 var_group">
        <div id="hidden_div" style="display:none">
            <input type="number" id="cell_editor" style="width: 65px;" step="any">
        </div>
        <table id="demographics_table" class="table table-striped" style="width: auto">
            <thead>
                <tr>
                    <th></th>
                    <th>{% trans "Men" %}</th>
                    <th>{% trans "Women" %}</th>
                    <th>{% trans "Boys" %}</th>
                    <th>{% trans "Girls" %}</th>
                    <th>{% trans "Males" %}</th>
                    <th>{% trans "Females" %}</th>
                    <th>{% trans "Adults" %}</th>
                    <th>{% trans "Children" %}</th>
                    <th>{% trans "Infants" %}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>{% trans "Embarked slaves (first port)" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Embarked slaves (second port)" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Embarked slaves (third port)" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Died on voyage" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Disembarked slaves (first port)" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Disembarked slaves (second port)" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                {% if mode == 'editorial_review' %}
                <tr>
                    <th>{% trans "Imputed number at ports of purchase" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Imputed number at ports of landing" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Imputed number at departure or arrival" %}</th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Imputed deaths on middle passage" %} 
                        <b-badge pill v-b-tooltip.hover title="Calculated by an algorithm and not based on historical record."
                        variant="secondary" class="v-badge-imputed">
                        IMPUTED</b-badge>
                    </th>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        <div class="form-group">
            <label for="notes_for_slaves_demographics">
                {% trans "Notes for slaves characteristics" %}:
            </label>
            <div class="input-group col-md-8 last_group_input">
                <textarea class="form-control not_selectized field_notes" id="notes_for_slaves_demographics" name="notes_for_slaves_demographics"></textarea>
            </div>
        </div>
    </div>
    </div>

    {% if mode == 'editorial_review' %}
    <!-- Slaves (age and sex) -->
    <div class="expander_container">
        <div>
            <div class="page-title-2">
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#age_and_sex" aria-expanded="false" aria-controls="age_and_sex">
              {% trans "Slaves (age and sex)" %}
            </a>
            </div>
        </div>
        <div id="age_and_sex" class="collapse col-md-12 var_group">
        <table id="age_and_sex_table" class="table table-striped" style="width: auto">
            <thead>
                <tr>
                    <th></th>
                    <th>{% trans "At ports of purchase" %}</th>
                    <th>{% trans "At ports of landing" %}</th>
                    <th>{% trans "At departure or on arrival" %}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>{% trans "Total identified by age (imputed)" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Total identified by gender (imputed)" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Total identified by age and gender (imputed)" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Percentage of men (imputed)" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Percentage of women (imputed)" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Percentage of boys (imputed)" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Percentage of girls (imputed)" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Child ratio (imputed)" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
                <tr>
                    <th>{% trans "Male ratio (imputed)" %}</th>
                    <td></td><td></td><td></td><td></td>
                </tr>
            </tbody>
        </table>
        </div>
    </div>
    {% endif %}

    <!-- Sources -->
    <div class="expander_container">
        <div>
            <div class="page-title-2">
            <a role="button" class="collapsed expander" data-toggle="collapse" href="#sources" aria-expanded="false" aria-controls="sources">
                {% trans "Sources" %}
            </a>
            </div>
        </div>
        <div id="sources" class="collapse col-md-12 var_group">
        {% if interim.pre_existing_sources.all %}
            <h3>{% trans "Current source references" %}</h3>
            {% trans "Please specify whether the sources below should be included, excluded, or edited." %}
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>{% trans "Voyage ID(s)" %}</th>
                    <th>{% trans "Short reference" %}</th>
                    <th>{% trans "Full reference" %}</th>
                    <th>{% trans "Action" %}</th>
                </tr>
                </thead>
                <tbody>
                {% for source in interim.pre_existing_sources.all %}
                    <tr>
                        <td>{{ source.voyage_ids }}</td>
                        <td>{{ source.original_ref }}</td>
                        <td>{{ source.full_ref|safe }}</td>
                        <td>
                            <div class="dropdown">
                                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    <span id="pre_source_action_span_{{ source.pk }}" class="fa fa-{% if source.action == 0 %}check-circle-o{% endif %}{% if source.action == 1 %}edit{% endif %}{% if source.action == 2 %}remove{% endif %}"></span>
                                </button>
                                <input type="hidden" id="pre_existing_source_action_{{ source.pk }}" name="pre_existing_source_action_{{ source.pk }}" value="{{ source.action }}">
                                <ul class="dropdown-menu pull-right">
                                <li><a href="#" class="pre_source_menu_accept" data-sourcepk="{{ source.pk }}" data-originalref="{{ source.original_ref }}">{% trans "Accept as it is" %}</a></li>
                                <li><a href="#" class="pre_source_menu_exclude" data-sourcepk="{{ source.pk }}" data-originalref="{{ source.original_ref }}">{% trans "Exclude reference (please explain)" %}</a></li>
                                <li><a href="#" class="pre_source_menu_edit" data-sourcepk="{{ source.pk }}" data-originalref="{{ source.original_ref }}">{% trans "Edit reference (please explain)" %}</a></li>
                                <li role="separator" class="divider"></li>
                                <li style="margin:10px; min-width: 400px;"><label for="pre_existing_source_notes_{{ source.pk }}">Notes:</label><textarea class="form-control not_selectized" name="pre_existing_source_notes_{{ source.pk }}" id="pre_existing_source_notes_{{ source.pk }}" type="text">{{ source.notes|default_if_none:'' }}</textarea></li>
                              </ul>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
        <button type="button" class="btn btn-outline" data-toggle="modal" data-target="#referencesModal" id="add_source_modal_btn">
          {% trans "Add source" %}
        </button>
        <table id="sources_table" style="display:none; table-layout: fixed;" class="table table-striped">
            <thead>
                <tr>
                    <th width="130px">{% trans "Type of source" %}</th>
                    <th>{% trans "Details" %}</th>
                    <th width="280px"></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    </div>

    <hr />
        <div class="form-group">
            <label for="contribution_main_notes">{% trans "Contributor’s comments on this entry:" %}</label>
            <div class="">
                <textarea class="form-control not_selectized" id="contribution_main_notes" name="contribution_main_notes">{{ contribution.notes|default_if_none:"" }}</textarea>
            </div>
        </div>
    <input id="global_notes_input" type="hidden" name="notes" />
    <div class="form-group ">
        <hr />
        {% if mode != 'editorial_review' or contribution.request.final_decision == 0 %}
        <button class="btn btn-solid" type="button" id="save_btn">{% trans "Save" %}</button>
        {% endif %}
        {% if mode == 'contribute' %}
        <button class="btn btn-outline" type="submit" onclick="submit_val='';">{% trans "Review" %}</button>
        <button class="btn btn-outline" type="submit" name="submit_val" value="delete" id="delete_contrib">{% trans "Cancel contribution" %}</button>
        {% endif %}
        &nbsp;<span id="success_info" class="alert alert-success" style="opacity: 0.0">{% trans "Form saved!" %}</span>
    </div>
    {% if mode == 'review' or mode == 'editorial_review' %}
        {% include "contribute/decision_part.html" with allow_impute=True review_request=contribution.request %}
    {% endif %}
</form>
{% if mode == 'editorial_review' %}
    <a id="return_btn" class="btn btn-default" href="/contribute/editor_main?tab=requests">{% trans "Return to requests list" %}</a>
{% endif %}
{% if mode == 'review' %}
    <a id="return_btn" class="btn btn-default" href="/contribute">{% trans "Return to Contribute home" %}</a>
{% endif %}
<div class="modal fade" id="referencesModal" tabindex="-1" role="dialog" aria-labelledby="referencesModalLabel" data-backdrop="static">
    <div class="modal-dialog" role="document" style="width: 80%;">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="referencesModalLabel">{% trans "Add a source reference" %}</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body" style="height: 500px; overflow-y: auto;">
                <input type="hidden" name="source_index_field" id="source_index_field" />
                <input type="hidden" name="source_pk_field" id="source_pk_field" />
                <ul class="nav nav-pills" role="tablist" id="tab_control">
                    <li data-tab="primary" data-sourcetype="Primary source" role="presentation" class="active nav-item"><a href="#primary"
                                                                                 class="nav-link active show"
                                                                                 aria-controls="primary"
                                                                                 role="tab" data-toggle="tab">
                        {% trans "Primary source" %}</a></li>
                    <li data-tab="article" data-sourcetype="Article source" role="presentation" class="nav-item"><a href="#article" aria-controls="article" class="nav-link"
                                                                  role="tab" data-toggle="tab">{% trans "Article" %}</a></li>
                    <li data-tab="book" data-sourcetype="Book source" role="presentation" class="nav-item"><a href="#book" aria-controls="book" role="tab" class="nav-link"
                                                               data-toggle="tab">{% trans "Book" %}</a></li>
                    <li data-tab="newspaper" data-sourcetype="Newspaper source" role="presentation" class="nav-item"><a href="#newspaper" aria-controls="newspaper" role="tab" class="nav-link"
                                                                data-toggle="tab">{% trans "Newspaper" %}</a></li>
                    <li data-tab="private" data-sourcetype="Private note or collection source" role="presentation" class="nav-item"><a href="#private" aria-controls="private" role="tab" class="nav-link"
                                                                data-toggle="tab">{% trans "Private note or collection" %}</a></li>
                    <li data-tab="unpub" data-sourcetype="Unpublished secondary source" role="presentation" class="nav-item"><a href="#unpub" aria-controls="unpub" role="tab" class="nav-link"
                                                                data-toggle="tab">{% trans "Unpublished secondary source" %}</a></li>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                    <!-- Primary sources tab -->
                    <div role="tabpanel" class="tab-pane active" id="primary">
                        <div class="form-group">
                            <label for="primary_name">{% trans "Name of library or archive" %}</label>
                            <input class="form-control not_selectized" type="text" id="primary_name">
                        </div>
                        <div class="form-group">
                            <label for="primary_loc">{% trans "Location of library/archive" %}</label>
                            <input class="form-control not_selectized" type="text" id="primary_loc">
                        </div>
                        <div class="form-group">
                            <label for="primary_series">{% trans "Series or collection" %}</label>
                            <input class="form-control not_selectized" type="text" id="primary_series">
                        </div>
                        <div class="form-group">
                            <label for="primary_vol">{% trans "Volume or box or bundle" %}</label>
                            <input class="form-control not_selectized" type="text" id="primary_vol">
                        </div>
                        <div class="form-group">
                            <label for="primary_detail">{% trans "Document detail (page or folio number, and/or date of document)" %}</label>
                            <input class="form-control not_selectized" type="text" id="primary_detail">
                        </div>
                        <div class="form-group">
                            <label for="primary_info">{% trans "Information about source" %}</label>
                            <textarea class="form-control not_selectized" id="primary_info"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="primary_url">{% trans "URLs or digitized image of the source to be submitted wherever possible about source" %}</label>
                            <textarea class="form-control not_selectized" id="primary_url"></textarea>
                        </div>
                    </div>
                    <!-- Article sources tab -->
                    <div role="tabpanel" class="tab-pane" id="article">
                        <div class="form-group">
                            <label for="article_author">{% trans "Author" %}</label>
                            <input class="form-control not_selectized" type="text" id="article_author">
                        </div>
                        <div class="form-group">
                            <label for="article_title">{% trans "Title" %}</label>
                            <input class="form-control not_selectized" type="text" id="article_title">
                        </div>
                        <div class="form-group">
                            <label for="article_journal">{% trans "Journal" %}</label>
                            <input class="form-control not_selectized" type="text" id="article_journal">
                        </div>
                        <div class="form-group">
                            <label for="article_volume">{% trans "Volume number" %}</label>
                            <input class="form-control not_selectized" type="text" id="article_volume">
                        </div>
                        <div class="form-group">
                            <label for="article_year">{% trans "Year" %}</label>
                            <input class="form-control not_selectized" type="text" id="article_year">
                        </div>
                        <div class="form-group">
                            <label for="article_first_page">{% trans "Page numbers" %}</label>
                            <div style="width: 100%; overflow-x: hidden">
                                <input class="form-control form-control-inline col-sm-2 not_selectized" type="text" id="article_first_page" style="width: 35%;">
                                <div style="display: inline; float: left;">&nbsp;-&nbsp;</div>
                                <input class="form-control form-control-inline col-sm-2 not_selectized" type="text" id="article_last_page" style="width: 35%;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="article_info">{% trans "Other information" %}</label>
                            <textarea class="form-control not_selectized" id="article_info"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="article_url">{% trans "URLs or digitized image of the source to be submitted wherever possible about source" %}</label>
                            <textarea class="form-control not_selectized" id="article_url"></textarea>
                        </div>
                    </div>
                    <!-- Book/Book essay sources tab -->
                    <div role="tabpanel" class="tab-pane" id="book">
                        <div class="form-group">
                            <label for="book_is_essay">{% trans "Source is an essay/chapter in a book" %}</label>
                            <input class="form-control not_selectized col-sm-1" type="checkbox" id="book_is_essay" onchange="$('.book_essay_input_group').toggle(this.checked);">
                        </div>
                        <div class="form-group book_essay_input_group" style="display: none;">
                            <label for="book_essay_title">{% trans "Essay/Chapter title" %}</label>
                            <input class="form-control not_selectized" type="text" id="book_essay_title">
                        </div>
                        <div class="form-group book_essay_input_group" style="display: none;">
                            <label for="book_editors">{% trans "Editors" %}</label>
                            <input class="form-control not_selectized" type="text" id="book_editors">
                        </div>
                        <div class="form-group">
                            <label for="book_author">{% trans "Author" %}</label>
                            <input class="form-control not_selectized" type="text" id="book_author">
                        </div>
                        <div class="form-group">
                            <label for="book_title">{% trans "Title" %}</label>
                            <input class="form-control not_selectized" type="text" id="book_title">
                        </div>
                        <div class="form-group">
                            <label for="book_publisher">{% trans "Publisher" %}</label>
                            <input class="form-control not_selectized" type="text" id="book_publisher">
                        </div>
                        <div class="form-group">
                            <label for="book_pub_place">{% trans "Place of publication" %}</label>
                            <input class="form-control not_selectized" type="text" id="book_pub_place">
                        </div>
                        <div class="form-group">
                            <label for="book_year">{% trans "Year" %}</label>
                            <input class="form-control not_selectized" type="text" id="book_year">
                        </div>
                        <div class="form-group">
                            <label for="book_first_page">{% trans "Page numbers" %}</label>
                            <div style="width: 100%; overflow-x: hidden">
                                <input class="form-control form-control-inline col-sm-2 not_selectized" type="text" id="book_first_page" style="width: 35%;">
                                <div style="display: inline; float: left;">&nbsp;-&nbsp;</div>
                                <input class="form-control form-control-inline col-sm-2 not_selectized" type="text" id="book_last_page" style="width: 35%;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="book_info">{% trans "Other information" %}</label>
                            <textarea class="form-control not_selectized" id="book_info"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="book_url">{% trans "URLs or digitized image of the source to be submitted wherever possible about source" %}</label>
                            <textarea class="form-control not_selectized" id="book_url"></textarea>
                        </div>
                    </div>
                    <!-- Newspaper sources tab -->
                    <div role="tabpanel" class="tab-pane" id="newspaper">
                        <div class="form-group">
                            <label for="newspaper_name">{% trans "Name" %}</label>
                            <input class="form-control not_selectized" type="text" id="newspaper_name">
                        </div>
                        <div class="form-group">
                            <label for="newspaper_alternative_name">{% trans "Alternative name" %}</label>
                            <input class="form-control not_selectized" type="text" id="newspaper_alternative_name">
                        </div>
                        <div class="form-group">
                            <label for="newspaper_city">{% trans "City" %}</label>
                            <input class="form-control not_selectized" type="text" id="newspaper_city">
                        </div>
                        <div class="form-group">
                            <label for="newspaper_country">{% trans "Country" %}</label>
                            <input class="form-control not_selectized" type="text" id="newspaper_country">
                        </div>
                        <div class="form-group">
                            <label for="newspaper_info">{% trans "Information about source" %}</label>
                            <textarea class="form-control not_selectized" id="newspaper_info"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="newspaper_url">{% trans "URLs or digitized image of the source to be submitted wherever possible about source" %}</label>
                            <textarea class="form-control not_selectized" id="newspaper_url"></textarea>
                        </div>
                    </div>
                    <!-- Private note or collection sources tab -->
                    <div role="tabpanel" class="tab-pane" id="private">
                        <div class="form-group">
                            <label for="pnc_authors">{% trans "Authors" %}</label>
                            <input class="form-control not_selectized" type="text" id="pnc_authors">
                        </div>
                        <div class="form-group">
                            <label for="pnc_title">{% trans "Title" %}</label>
                            <input class="form-control not_selectized" type="text" id="pnc_title">
                        </div>
                        <div class="form-group">
                            <label for="pnc_location">{% trans "Location" %}</label>
                            <input class="form-control not_selectized" type="text" id="pnc_location">
                        </div>
                        <div class="form-group">
                            <label for="pnc_page">{% trans "Page" %}</label>
                            <input class="form-control not_selectized" type="text" id="pnc_page">
                        </div>
                        <div class="form-group">
                            <label for="pnc_info">{% trans "Information about source" %}</label>
                            <textarea class="form-control not_selectized" id="pnc_info"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="pnc_url">{% trans "URLs or digitized image of the source to be submitted wherever possible about source" %}</label>
                            <textarea class="form-control not_selectized" id="pnc_url"></textarea>
                        </div>
                    </div>
                    <!-- Unpublished secondary sources tab -->
                    <div role="tabpanel" class="tab-pane" id="unpub">
                        <div class="form-group">
                            <label for="unpub_authors">{% trans "Authors" %}</label>
                            <input class="form-control not_selectized" type="text" id="unpub_authors">
                        </div>
                        <div class="form-group">
                            <label for="unpub_title">{% trans "Title" %}</label>
                            <input class="form-control not_selectized" type="text" id="unpub_title">
                        </div>
                        <div class="form-group">
                            <label for="unpub_location">{% trans "Location" %}</label>
                            <input class="form-control not_selectized" type="text" id="unpub_location">
                        </div>
                        <div class="form-group">
                            <label for="unpub_page">{% trans "Page" %}</label>
                            <input class="form-control not_selectized" type="text" id="unpub_page">
                        </div>
                        <div class="form-group">
                            <label for="unpub_info">{% trans "Information about source" %}</label>
                            <textarea class="form-control not_selectized" id="unpub_info"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="unpub_url">{% trans "URLs or digitized image of the source to be submitted wherever possible about source" %}</label>
                            <textarea class="form-control not_selectized" id="unpub_url"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="add_source_btn" type="button" class="btn btn-primary">{% trans "Add" %}</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="create_ref_dialog" tabindex="-1" role="dialog" aria-labelledby="create_ref_dialog_label" data-backdrop="static" >
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="create_ref_dialog_label">{% trans "Edit or create sources reference" %}</h4>
            </div>
            <div id="create_ref_dialog_body" class="modal-body" style="height: 500px; overflow-y: auto;">
            </div>
            <div class="modal-footer">
                <button id="create_ref_confirm_btn" type="button" class="btn btn-primary">{% trans "Confirm" %}</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">{% trans "Cancel" %}</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="{{ STATIC_URL }}scripts/library/selectize.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}scripts/contribute/interim.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}scripts/library/js.cookie@2.1.0.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}scripts/contribute/common.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}scripts/legacy/utils.js"></script>
<script type="text/javascript">
    var MODIFY_REFERENCE_TEXT = '{% trans "Modify reference" %}';
    var submit_val = '';
    // Existing voyage(s) data.
    var voyages = {{ voyages_data|safe }};

    // Keep a source index so that each new source gets a unique identifier.
    var _sourceIndex = 0;
    var all_source_types = [
        {% if sources_post %}
            {{ sources_post|safe }}
        {% else %}
            {{ interim.primary_sources.all|jsonify }},
            {{ interim.article_sources.all|jsonify }},
            {{ interim.book_sources.all|jsonify }},
            {{ interim.newspaper_sources.all|jsonify }},
            {{ interim.private_note_or_collection_sources.all|jsonify }},
            {{ interim.unpublished_secondary_sources.all|jsonify }},
        {% endif %}
    ];
    var sources = [];
    for (var i = 0; i < all_source_types.length; ++i) {
        sources = sources.concat($.map(all_source_types[i], function(a) {
            return sourceFactory(a, ++_sourceIndex);
        }));
    }
    function getSourceByIndex(index) {
        for (var k = 0; k < sources.length; ++k) {
            if (sources[k].index == index) {
                return sources[k];
            }
        }
        return null;
    }

    function editSource(index) {
        var s = getSourceByIndex(index);
        if (s) {
            s.bindToForm();
            $('.nav-tabs a[href="#' + s.type.split(' ', 1)[0].toLowerCase() + '"]').tab('show');
            $("#add_source_btn").html('{% trans "Save changes"  %}');
            $('#referencesModal').modal('show');
        }
    }

    {% if mode == 'editorial_review' %}
    var createdNewSource = null;
    function createOrEditReference(item) {
        var data = {};
        var original_ref = $(item).data('originalref');
        var index = $(item).data('index');
        if (index) {
            index = parseInt(index);
            var sourceWithIndex = getSourceByIndex(index);
            createdNewSource = sourceWithIndex.toModel();
            createdNewSource.index = index;
            data.interim_source = createdNewSource;
        } else {
            createdNewSource = null;
        }
        if (original_ref) {
            data.mode = 'edit';
            data.original_ref = original_ref;
        } else {
            data.mode = 'new';
        }
        $.ajax({
            url: '/contribute/editorial_sources',
            data: data,
            method: 'POST',
            success: function(result) {
                if (result.errors) {
                    alert(result.errors);
                } else {
                    $('#create_ref_dialog_body').html(result);
                    $('#create_ref_dialog_body script').appendTo($('head'));
                    $('#create_ref_dialog_body textarea, #create_ref_dialog_body select').addClass('form-control');
                    window.tinymce.dom.Event.domLoaded = true;
                    tinymce.init({ resize: false, selector:'#id_full_ref' });
                    $('#create_ref_dialog').modal('show');
                }
            }
        });
        return false;
    }
    $('#create_ref_confirm_btn').click(function(e) {
        e.preventDefault();
        // Validate reference.
        var data = {
            interim_pk: {{ interim.pk }},
            short_ref: $('#id_short_ref').val(),
            full_ref: tinyMCE.activeEditor.getContent(),
            source_type: $('#id_source_type').val(),
            connection_ref: $('#id_connection_ref').val()
        }
        var errors = [];
        var warnings = [];
        if (data.short_ref.length < 1) {
            errors.push('{% trans "Short reference must not be empty" %}');
        }
        if (data.full_ref.length < 3) {
            errors.push('{% trans "Full reference is too short" %}');
        }
        if (!data.connection_ref.startsWith(data.short_ref)) {
            errors.push('{% trans "Text reference must start with short reference" %}')
        } else {
            var suffix = data.connection_ref.substr(data.short_ref.length);
            var regex = /^[a-z\d\s\.\-_/:,]+$/i;
            if (!regex.test(suffix)) {
                warnings.push('{% trans "Suffix should be alphanumeric and contain only restricted special symbols" %}');
            }
        }
        if (errors.length) {
            alert('{% trans "Validation errors" %}\n' + errors.join('\n'));
            return false;
        }
        if (warnings.length) {
            if (!confirm('{% trans "Validation warnings" %}\n' + warnings.join('\n') + '\n{% trans "Confirm anyway?" %}')) return false;
        }
        if (createdNewSource) {
            data.interim_source_id = createdNewSource['type'] + '/' + createdNewSource['pk'];
            data.interim_source = createdNewSource;
        }
        data.mode = 'save';
        // Save data.
        $.ajax({
            url: '/contribute/editorial_sources',
            data: data,
            method: 'POST',
            success: function(result) {
                if (result.errors) {
                    alert(result.errors);
                } else if (createdNewSource) {
                    createdNewSource['created_voyage_sources_id'] = result.created_voyage_sources_id;
                    createdNewSource['pk'] = parseInt((result.interim_source_id || createdNewSource['pk']).split('/')[1]);
                    createdNewSource['source_ref_text'] = data.connection_ref;
                    for (var i = 0; i < sources.length; ++i) {
                        if (sources[i].index == createdNewSource.index) {
                            sources[i].fromModel(createdNewSource);
                            break;
                        }
                    }
                    $('.create_ref_btn').each(function() {
                        var $btn = $(this);
                        if ($btn.data('index') == createdNewSource.index) {
                            $btn.data('originalref', data.connection_ref);
                            $btn.text(MODIFY_REFERENCE_TEXT);
                        }
                    });
                }
                $('#create_ref_dialog').modal('hide');
            }
        });
    });
    {% endif %}

    // Removes the source from the table and array.
    function removeSource(index, force) {
        if (!force && !confirm('{% trans "Remove this source?" %}')) return;
        for (var k = 0; k < sources.length; ++k) {
            if (sources[k].index == index) {
                sources.splice(k, 1);
                $("#row_source_" + index).remove();
                if (!sources.length) {
                    $('#sources_table').hide();
                }
                return;
            }
        }
    }

    function expandAll() {
        $('.collapse').collapse('show');
    }

    var getValues = function(name) {
        return getVoyagesValues(voyages, name);
    };

    var selectizeInput = function(input) {
        var values = getValues(input.attr('name'));
        var optgroups = [];
        for (var value in values) {
            var ids = values[value];
            optgroups.push({ id: value, label: getGroupName(ids), $order: -1000 });
        }
        var nodeName = input[0].nodeName.toUpperCase();
        if (values && nodeName == 'INPUT') {
            var options = [];
            var currentValue = input.attr('value') || input.val();
            optgroups.push({ id: 'typed', label: gettext('Typed value')});
            for (var value in values) {
                options.push({ source: value, value: value });
                if (value == currentValue) {
                    currentValue = '';
                }
            }
            if (currentValue != '') {
                options.push({ source: 'typed', value: currentValue });
            }
            input.selectize({
                create: function (x, callback) {
                    callback({ source: 'typed', value: x });
                },
                delimiter: '#%#$', // avoid problems when commas are part of the input text.
                persist: false,
                closeAfterSelect: false,
                options: options,
                labelField: 'value',
                valueField: 'value',
                optgroups: optgroups,
                optgroupField: 'source',
                optgroupLabelField: 'label',
                optgroupValueField: 'id',
                searchField: ['value'],
                selectOnTab: true,
                maxItems: 1,
                plugins: ['optgroup_columns', 'restore_on_backspace']
            });
            if (options.length == 1 && currentValue == '') {
                input.val(options[0].value);
            }
        } else if (nodeName == 'SELECT') {
            var $s = input.selectize({
                optgroupField: 'source',
                selectOnTab: true,
                sortField: [{ field: 'priority' }, { field: 'text' }],
                lockOptgroupOrder: true,
                onInitialize: function() {
                    for (var key in optgroups) {
                        var og = optgroups[key];
                        this.addOptionGroup(og.id, og);
                    }
                    if (values) {
                        for (var value in values) {
                            var found = -1;
                            var list = this.options;
                            for (var i in list) {
                                if (list[i].value == value) {
                                    found = i;
                                    break;
                                }
                            }
                            if (found < 0) continue;
                            //this.options[found] = { source: value, value: list[found].value, text: list[found].text };
                            this.options["@fake" + found] = { source: value, value: list[found].value, text: list[found].text };
                        }
                    }
                },
            });
        } else {
            addNotesPopup(input.attr('name'), input.parent());
        }
        input.addClass('form-control');
    };

    var regions = {};
    var broad_regions = {};

    $(document).ready(function() {
        $('.form-horizontal .form-group>label').addClass('control-label col-sm-12 col-md-12 col-lg-12');
        var $return_btn = $('#return_btn');
        if ($return_btn.length) {
            $return_btn.appendTo($('#decision_btn_group'));
        }
        // Store numbers in an object.
        var numbers = {
        {% for k, v in numbers.items %}
            {% if v %}
            {% localize off %}
                '{{ k }}': {{ v }},
            {% endlocalize %}
            {% endif %}
        {% endfor %}
        };

        // Set demographic table.
        var demographics_table = demographicsTable(numbers, true, voyages);
        var age_and_sex_table = ageAndSexTable(numbers, true, voyages);

        $('#delete_contrib').click(function(e) {
            if (!confirm('{% trans "The contribution will be deleted. Continue anyway?" %}')) {
                e.preventDefault();
            } else {
                submit_val = 'delete';
            }
        });

        $('.year_range').each(function() {
            var self = $(this);
            var mod = self.data('yearmod');
            var options = [];
            var index = 0;
            for (var start = 1500; start < 1870; start += mod) {
                options.push({label: (start + 1) + '-' + (start + mod), value: ++index});
            }
            var input = self.children('input');
            input.addClass('not_selectized');
            input.selectize({
                options: options,
                valueField: 'value',
                labelField: 'label',
            });
        });

        $('input[type=text], input[type=number], select, textarea')
            .not('.select_port')
            .not('.select_region')
            .not('.date_input')
            .not('.not_selectized')
            .each(function () {
                var f = $(this);
                if (!f.parent().hasClass('selectize-input')) {
                    selectizeInput(f);
                }
            }
        );

        // Add group with most common options for select items
        var selectize = $("#id_{{ form.voyage_outcome.html_name }}")[0].selectize;
        selectize.addOptionGroup('most_common', {
            label: '{% trans "Most common outcomes" %}',
            $order: -100,
        });
        var commonIds = [1, 42, 173, 64, 52]
        for (var i in selectize.options) {
            var found = selectize.options[i];
            if (selectize.optgroups[found.source].$order < 0) continue;
            var commonIndex = $.inArray(parseInt(found.value), commonIds);
            if (commonIndex >= 0) {
                selectize.options[i] = { priority: commonIndex, source: 'most_common', value: found.value, text: found.text };
            }
        }

        $.ajax('/contribute/places_ajax', {
            success: function(originalPorts) {
                var regionsList = [];
                for (var i = 0; i < originalPorts.length; ++i) {
                    var item = originalPorts[i];
                    if (item.type == "region") {
                        regions[item.pk] = item;
                        regionsList.push(item);
                    } else if (item.type == "broad_region") {
                        broad_regions[item.pk] = item;
                    }
                    item.source = 'data';
                }
                $(".select_region").each(function() {
                    var self = $(this);
                    self.selectize({
                        maxItems: 1,
                        options: regionsList,
                        labelField: 'region',
                        sortField: 'region',
                        valueField: 'pk',
                        selectOnTab: false,
                    });
                });
                var EXISTING_PREFIX = '@existing_';
                $(".select_port").each(function() {
                    var self = $(this);
                    var ports = originalPorts.slice(0);
                    var values = getValues(self.attr('name'));
                    var optgroups = [ { id: 'data', label: '{% trans 'Ports' %}' } ];
                    for (var value in values) {
                        for (var j = 0; j < ports.length; ++j) {
                            var p = ports[j];
                            if (p.type == 'port' && p.value == value) {
                                // Found the port matching a pre-existing value.
                                var copy = jQuery.extend({}, p);
                                copy.value = EXISTING_PREFIX + copy.value;
                                copy.type = 'existing';
                                copy.source = getGroupName(values[value]);
                                copy.order = 0;
                                optgroups.push({ id: copy.source, label: copy.source });
                                ports.unshift(copy);
                                break;
                            }
                        }
                    }
                    var portItemDisplay = function(data, escape) {
                        var region = regions[data.parent];
                        var broad_region = broad_regions[region.parent];
                        return '<div><span class="geo_complement">' + broad_region.broad_region + ' &raquo; ' + region.region + ' &raquo; </span>' + escape(data.port) + '</div>';
                    };
                    self.selectize({
                        maxItems: 1,
                        options: ports,
                        optgroups: optgroups,
                        optgroupField: 'source',
                        optgroupLabelField: 'label',
                        optgroupValueField: 'id',
                        valueField: 'value',
                        searchField: ['port', 'region', 'broad_region'],
                        selectOnTab: false,
                        sortField: 'order',
                        render: {
                            option: function(data, escape) {
                                if (data.type == 'port') {
                                    return '<div class="port region_' + data.parent + '">' + escape(data.port) + '</div>';
                                }
                                if (data.type == 'region') {
                                    return '<div id="r_' + data.pk + '" data-pk="' + data.pk + '" class="mouse_transparent tree_collapsed region broad_region_' + data.parent + '">' + escape(data.region) + '</div>';
                                }
                                if (data.type == 'existing') {
                                    return portItemDisplay(data, escape);
                                }
                                return '<div id="br_' + data.pk + '" data-pk="' + data.pk + '" class="mouse_transparent broad_region tree_collapsed">' + escape(data.broad_region) + '</div>';
                            },
                            item: portItemDisplay,
                        }
                    });
                    self.change(function() {
                        var value = self.val();
                        if ($.type(value) === 'string' && value.startsWith(EXISTING_PREFIX)) {
                            self.val(value.substring(EXISTING_PREFIX.length));
                        }
                    });
                });
            }
        });

        // Handle dates.
        var dateOptions = [];
        for (var i = 1500; i <= 1867; ++i) {
            dateOptions.push({ type: 'year', label: i, value: 'y' + i, search: i });
        }

        {% get_current_language as LANGUAGE_CODE %}
        var locale = "{{ LANGUAGE_CODE }}";
        var getMonthName = function(i) {
            return getMonthLocaleName(locale, i);
        };
        var leadingZero = function(d) {
            return d < 10 ? '0' + d : '' + d;
        };
        for (var i = 1; i <= 12; ++i) {
            var month = getMonthName(i);
            dateOptions.push({ type: 'month', label: month, value: 'm' + leadingZero(i), search: month + ' (' + leadingZero(i) + ')' });
        }
        for (var i = 1; i <= 31; ++i) {
            dateOptions.push({ type: 'day', label: (i < 10 ? '0' : '') + i, value: 'd' + leadingZero(i), search: leadingZero(i) });
        }
        $(".date_input").each(function() {
            var self = $(this);
            var optgroups = [
                { type: 'year', name: '{% trans "Year in the range" %} 1500 - 1867'},
                { type: 'month', name: '{% trans "Month" %}'},
                { type: 'day', name: '{% trans "Day" %}'},
            ];
            var values = getValues(self.attr('id').substring(3));
            var options = dateOptions.slice(0);
            var existing = {};
            for (var value in values) {
                if (value == ',,') continue;
                // Parse value in MM,DD,YYYY format.
                var parse = value.split(',');
                if (parse.length != 3) continue;
                parse[0] = parseInt(parse[0]);
                parse[1] = parseInt(parse[1]);
                parse[2] = parseInt(parse[2]);
                var label = '';
                if (parse[2] != '' && !isNaN(parse[2])) label += parse[2];
                if (parse[0] != '' && !isNaN(parse[0])) label += ', ' + getMonthName(parse[0]);
                if (parse[1] != '' && !isNaN(parse[1])) label += ', ' + parse[1];
                var item = { type: value, label: label, value: 'full_' + value, year: parse[2], month: parse[0], day: parse[1] };
                existing[item.value] = item;
                options.unshift(item);
                optgroups.unshift({ type: value, name: getGroupName(values[value]) });
            }
            var current_value = self.attr('value');
            var parse = current_value.split(',');
            current_value = '';
            if (parse.length == 3) {
                var valid = []
                if (parse[2] != '' && !isNaN(parse[2])) valid.push('y' + parse[2]);
                if (parse[0] != '' && !isNaN(parse[0])) valid.push('m' + leadingZero(parse[0]));
                if (parse[1] != '' && !isNaN(parse[1])) valid.push('d' + leadingZero(parse[1]));
                current_value = valid.join(',');
            }
            self.val(current_value);
            self.selectize({
                options: options,
                maxItems: 3,
                searchField: ['search'],
                selectOnTab: false,
                valueField: 'value',
                labelField: 'label',
                optgroupLabelField: 'name',
                optgroupValueField: 'type',
                optgroupField: 'type',
                optgroups: optgroups,
                render: {
                    option: function(data, escape) {
                        if (data.type == 'year') {
                            return '<div class="selectize_year">' + escape(data.label) + '</div>';
                        }
                        if (data.type == 'month') {
                            return '<div class="selectize_month">' + escape(data.search) + '</div>';
                        }
                        if (data.type == 'day') {
                            return '<div class="selectize_day">' + escape(data.label) + '</div>';
                        }
                        return '<div class="selectize_full">' + escape(data.label) + '&nbsp;</div>';
                    },
                },
                score: function(search) {
                    var score = this.getScoreFunction(search);
                    var current = $.map(self[0].selectize.items, function(s) { return s[0]; });
                    return function(item) {
                        var stype = item.type[0];
                        // If not expected type omit result.
                        var allowed = 'y';
                        if (current.indexOf('y') >= 0) {
                            allowed = 'm';
                            if (current.indexOf('m') >= 0) {
                                 allowed = current.indexOf('d') >= 0 ? '' : 'd';
                            }
                        }
                        if (stype != allowed) return 0.0;
                        if (stype == 'd' && search.length == 1) return score(item) * (parseInt(item.label) < 10 ? 5 : 1);
                        return stype == 'y' && search.length != 4 ? 0.0 : score(item);
                    };
                },
            });
            var inside = false;
            var selectize = this.selectize;
            var originalKeyDown = selectize.onKeyDown;
            selectize.onKeyDown = function(e) {
                // Treat tab, space, slash, dash as a RETURN.
                var isSelectionChar = e.keyCode == 109 || e.keyCode == 111 || e.keyCode == 32 || e.keyCode == 9;
                if (selectize.$activeOption && isSelectionChar) {
                    e.keyCode = 13;
                }
                return originalKeyDown.call(selectize, e);
            };
            selectize.on('item_add', function(value, item) {
                if (inside) return;
                if (value.startsWith('full')) {
                    this.clear();
                    inside = true;
                    var data = existing[value];
                    if (data.year) this.addItem('y' + data.year);
                    if (data.month) this.addItem('m' + leadingZero(data.month));
                    if (data.day) this.addItem('d' + leadingZero(data.day));
                    inside = false;
                    return;
                }
                // See if there is an item with the same type already selected,
                // if so, delete the item so only the new entry is kept.
                var type = value.charAt(0);
                for (var i = 0; i < this.items.length; ++i) {
                    var val = this.items[i];
                    if (val.charAt(0) == type && val != value) {
                        this.removeItem(val);
                        break;
                    }
                }
                var clone = this.items.slice(0).sort();
                // Place the items in the appropriate order:
                for (var i = clone.length - 1; i >= 0; --i) {
                    var val = clone[i];
                    this.removeItem(val);
                }
                inside = true;
                for (var i = clone.length - 1; i >= 0; --i) {
                    var val = clone[i];
                    this.addItem(val);
                }
                inside = false;
            });
        });

        // Highlight labels of fields with pre-existing values:
        var fieldValues = {};
        var preDataCount = 0;
        for (var id in voyages) {
            var v = voyages[id];
            ++preDataCount;
            for (var name in v) {
                var value = v[name];
                var itemId = (name.startsWith(NUMBERS_KEY_PREFIX) ? '' : 'id_') + name;
                var data = fieldValues[name];
                if (!data) fieldValues[name] = data = { itemId: itemId, values: [], dict: {} };
                if (value != null && value != ',,') {
                    data.values.push(value);
                    data.dict[id] = value;
                    $('label[for="' + itemId + '"]').addClass('has_pre_existing_values');
                }
            }
        }

        if (preDataCount > 0) {
            $('.control-label').replaceWith(function() {
                // Get the id of control matching the label.
                var originalField = $(this).attr('for');
                var field = originalField;
                if (field.startsWith('id_')) field = field.substring(3);
                var fv = fieldValues[field]
                if (!fv) return this.outerHTML;
                var afv = fieldValues[field + '_name'] || fv;
                var values = '';
                var width = (60.0 / preDataCount) + '%';
                for (var id in voyages) {
                    var value = afv.dict[id] || '';
                    // Check if this is a date to properly format it.
                    if (field.includes('date')) {
                        var arr = value.split(',');
                        if (arr.length == 3) {
                            value = arr[2] + ' ' + (arr[0] ? getMonthName(arr[0]) + ' ' : '') + arr[1];
                            value.trim();
                        }
                    }
                    values += '<td width="' + width + '" class="pre-value-cell" data-field="' + originalField + '" data-value="' + (fv.dict[id] || '') + '">' + value + '</td>';
                }
                return '<table class="col-sm-4 label-table"><tr><td width="40%">' + $(this).removeClass('col-sm-4')[0].outerHTML + '</td>' + values + '</tr></table>';
            });

            $('.pre-value-cell').click(function() {
                var $this = $(this);
                var field = $this.data('field');
                var value = $this.data('value');
                var $target = $('#' + field);
                var sel = $target[0].selectize;
                if (sel) {
                    if (field.includes('_date_')) {
                        // Unpack values.
                        var arr = value.split(',');
                        if (arr.length == 3) {
                            var items = [];
                            var padInt = function(s) { var a = "" + (parseInt(s) + 100); return a.substring(a.length - 2); };
                            if (arr[0] != '') items.push('m' + padInt(arr[0]));
                            if (arr[1] != '') items.push('d' + padInt(arr[1]));
                            if (arr[2] != '') items.push('y' + arr[2]);
                            sel.setValue(items);
                        }
                    } else {
                        sel.setValue(value);
                    }
                } else {
                    $target.val(value);
                }
            });
        }

        for (var key in fieldValues) {
            var x = fieldValues[key];
            if (x.values.length == 0) continue;
            // Check if all values are the same.
            var areEqual = x.values.length == preDataCount;
            var first = x.values[0];
            for (var i = 1; areEqual && i < x.values.length; ++i) {
                areEqual = x.values[i] == first;
            }
            $('label[for="' + x.itemId + '"]').closest('table').addClass(areEqual ? 'equal_pre_existing_values' : 'different_pre_existing_values');
        }

        $('.last_group_input, .last_group_input input, .last_group_input select, .last_group_input textarea').keydown(function(e) {
            if (e.keyCode == KEY_TAB) {
                e.preventDefault();
                e.stopPropagation();
                var $expander = $(this).closest('.expander_container').next().find('.collapse');
                $expander.collapse('show');
                if ($expander.attr('id') == 'demographics') {
                    demographics_table.focus();
                } else if ($expander.attr('id') == 'age_and_sex') {
                    age_and_sex_table.focus();
                } else {
                    $expander.find(':input:visible:enabled:first').focus();
                }
            }
        });

        var addSourceToTable = function(source, isEdit) {
            if (isEdit) removeSource(source.index, true);
            var editorialCommands = '';
            {% if mode == 'editorial_review' %}
                var sources_ref = source.text_ref;
                editorialCommands = '<a class="create_ref_btn btn btn-default" href="#" onclick="return createOrEditReference(this);" data-index="' + source.index + '" data-originalref="' + (sources_ref || '') + '">' + (sources_ref ? MODIFY_REFERENCE_TEXT : '{% trans "Create reference" %}') + '</a>'
            {% endif %}
            $('#sources_table > tbody:last-child').append('<tr id="row_source_' + source.index + '"><td>' + source.type + '</td><td>' + source.toString() + '</td><td><div class="btn-group" style="float:right;"><a href="#" class="btn btn-primary" onclick="editSource(' + source.index + '); return false;">{% trans "Edit" %}</a><a href="#" class="btn btn-danger" onclick="removeSource(' + source.index + '); return false;">{% trans "Remove" %}</a>' + editorialCommands + '</div></td></tr>');
            $('#sources_table').show();
        };

        $("#add_source_modal_btn").click(function () {
            $("#referencesModal input, #referencesModal textarea").val('');
            var index = ++_sourceIndex;
            $("#source_index_field").val(index);
            $("#add_source_btn").html('{% trans "Add"  %}');
        });

        $("#add_source_btn").click(function () {
            var typeName = $("ul#tab_control li.active").data("sourcetype");
            $('#sources_table').show();
            var source = createSourceByTypeName(typeName);
            if (source) {
                source.bindFromForm();
                var validation = source.validate();
                if (validation.hasErrors()) {
                    alert(validation.toString());
                    return false;
                } else if (!validation.hasWarnings() ||
                        confirm(validation.toString() + "\n" + gettext('Continue anyway?'))) {
                    addSourceToTable(source, true);
                    sources.push(source);
                    $('#referencesModal').modal('hide');
                }
            }
        });

        for (var i = 0; i < sources.length; ++i) {
            addSourceToTable(sources[i]);
        }
        if (sources.length) {
            $('#sources_table').show();
        }

        var sourceIcons = ['check-circle-o', 'edit', 'remove'];
        var sourceMenu = function (src, action) {
            var pk = $(src).data('sourcepk');
            var span = $('#pre_source_action_span_' + pk);
            span.removeClass();
            span.addClass("fa fa" + sourceIcons[action]);
            $('#pre_existing_source_action_' + pk).val(action);
            {% if mode == 'editorial_review' %}
            if (action == 1) {
                createOrEditReference(src);
            } else {% endif %} if (action > 0) {
                $('#pre_existing_source_notes_' + pk).focus();
            }
            return false;
        };

        $('.pre_source_menu_accept').click(function (e) {
            return sourceMenu(this, 0);
        });
        $('.pre_source_menu_edit').click(function (e) {
            return sourceMenu(this, 1);
        });
        $('.pre_source_menu_exclude').click(function (e) {
            return sourceMenu(this, 2);
        });

        // Parse notes.
        var NOTES_PREFIX = 'notes_for_';
        {% if interim.notes %}
        var notes = {{ interim.notes|safe }};
        // Remark: the note text area elements may not be ready yet.
        var missing = [];
        for (var key in notes) {
            var notesElement = $('#' + NOTES_PREFIX + key);
            if (notesElement.length > 0) {
                notesElement.val(notes[key]).change();
            } else {
                missing.push(key);
            }
        }
        if (missing.length > 0) {
            // If the comment text areas have not been generated yet,
            // we keep running a timer to assign the comments until
            // they are found.
            var timer = null;
            var count = missing.length;
            timer = setTimeout(
                function() {
                    for (var i = 0; i < missing.length; ++i) {
                        if (missing[i] == null) continue;
                        var notesElement = $('#' + NOTES_PREFIX + missing[i]);
                        if (notesElement.length > 0) {
                            notesElement.val(notes[missing[i]]).change();
                            missing[i] = null;
                            --count;
                        }
                    }
                    if (count == 0) {
                        clearTimeout(timer);
                    }
                },
                500);
        }
        {% else %}
        var notes = {};
        {% endif %}

        var formSubmission = function(allowEmptySources, showErrors) {
            allowEmptySources = allowEmptySources || false;
            $("input[name^='date']").each(function() {
                var self = $(this);
                // Convert date to the expected format MM,DD,YYYY
                var date = parseDateValue($('#id_' + self.attr('name')).val());
                self.val(date.toMMDDYYYY());
            });
            // Send notes.
            var notes_submit = {};
            var prefix_length = NOTES_PREFIX.length;
            $.map($(".field_notes"), function(note, i) {
                var $note = $(note);
                var note_val = $note.val();
                if (note_val != '') {
                    var attr = $note.attr('name');
                    if (attr.startsWith(NOTES_PREFIX)) {
                        attr = attr.substring(prefix_length);
                    }
                    notes_submit[attr] = note_val;
                }
            });
            $("#global_notes_input").val(JSON.stringify(notes_submit));
            // Remove previously appended fields.
            $('.' + APPENDED_FIELD_CLASS).remove();
            var form = $('form');
            // Append demographics matrix.
            demographics_table.appendToForm(form);
            {% if mode != 'contribute' %}
            age_and_sex_table.appendToForm(form);
            {% endif %}
            // Create JSON with source table data for submission.
            var $sources = $('<input class="' + APPENDED_FIELD_CLASS + '" type="hidden" name="sources" />');
            var source_models = $.map(sources, function(s, i) {
                return s.toModel();
            });
            $sources.val(JSON.stringify(source_models));
            form.append($sources);
            if (submit_val != 'delete') {
                // Build pre-existing sources list.
                var preSources = $.map(
                    [{% for source in interim.pre_existing_sources.all %}{{ source.pk }}{% if not forloop.last %},{% endif %}{% endfor %}],
                    function(pk, i) {
                        return {
                            'pk': pk,
                            'action': parseInt($('#pre_existing_source_action_' + pk).val()),
                            'notes': $('#pre_existing_source_notes_' + pk).val()
                        };
                    }
                );
                if (sources.length > 0 || preSources.length > 0 || !allowEmptySources) {
                    var validation = validatePreSubmit(sources, preSources);
                    if (validation.hasErrors()) {
                        if (showErrors) alert(validation.toString());
                        return false;
                    } else if (validation.hasWarnings() && showErrors &&
                            !confirm(validation.toString() + "\n" + gettext('Do you want to submit this voyage anyway?'))) {
                        return false;
                    }
                }
            }
            return true;
        };

        $('form').submit(function() { return formSubmission(false, true); });
        {% if mode == 'review' or mode == 'editorial_review' %}
            initDecisionForm(
                function(showErrors) { return formSubmission(false, showErrors); },
                {{ form.persisted_form_data.value|safe }});
        {% endif %}

        // Ajax save.
        $('#save_btn').click(function() {
            var self = $(this);
            var valid = formSubmission(true, true);
            if (valid) {
                self.prop('disabled', true);
                $.ajax({
                    type: "POST",
                    {% if mode == 'contribute' %}
                    url: '{{ request.path }}/save_ajax',
                    {% else %}
                    url: '/contribute/{{ mode }}/{{ contribution.pk }}/save_ajax',
                    {% endif %}
                    data: $('form').serialize(),
                    success: function (response) {
                        if (response.valid) {
                            var $success = $('#success_info');
                            $success.css('opacity', 1.0);
                            $success.animate({
                                    opacity: 0.0
                                },
                                5000
                            );
                            if (response.src_pks) {
                                for (var index in response.src_pks) {
                                    var source = getSourceByIndex(index);
                                    var source_pk = response.src_pks[index];
                                    if (source.pk && source.pk != source_pk) {
                                        console.log('A source had its primary key changed!');
                                    }
                                    source.pk = source_pk;
                                }
                            }
                        }
                        else {
                            alert(response.errors);
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert('Error saving: ' + textStatus);
                    },
                    complete: function() {
                        self.prop('disabled', false);
                    }
                });
            }
            return false;
        });
        var pageParams = pageGetParams();
        if (pageParams.expandAllSections) {
            expandAll();
        }
    });

    // Special handling of port/region/broad region selection.
    var protoSelectOption = Selectize.prototype.onOptionSelect;
    Selectize.prototype.onOptionSelect = function(e) {
        if (this.$input.hasClass('select_port') && e && e.currentTarget) {
			if (e.preventDefault) {
			    e.preventDefault();
			    e.stopPropagation();
			}
            if (e.type && e.type == 'mousedown') return false;
            var target = $(e.currentTarget);
            var className = "expanded";
            if (this.$control_input.val() != '' && !this.options.create) {
                // Clear search if user selected an option.
                id = target.attr('id');
                this.$control_input.val('');
                this.refreshOptions();
                if (id) {
                    target = $("#" + id);
                }
            }
            var nextActive = null;
            if (target.hasClass("broad_region")) {
                nextActive = ".broad_region_" + target.data('pk');
                var isExpanded = $(nextActive + ":first").hasClass(className);
                $(".broad_region,.region,.port").removeClass(className);
                $(".tree_expanded").removeClass('tree_expanded').addClass("tree_collapsed");
                if (isExpanded) return false;
                target.removeClass("tree_collapsed").addClass("tree_expanded").addClass(className);
                $(".broad_region_" + target.data('pk')).addClass(className);
                this.setTextboxValue('');
            } else if (target.hasClass("region")) {
                nextActive = ".region_" + target.data('pk');
                var isExpanded = $(nextActive + ":first").hasClass(className);
                $(".port").removeClass(className);
                $(".region.tree_expanded").removeClass('tree_expanded').addClass("tree_collapsed");
                if (isExpanded) return false;
                target.removeClass("tree_collapsed").addClass("tree_expanded").addClass(className);;
                $(".region_" + target.data('pk')).addClass(className);
                this.setTextboxValue('');
            } else {
                protoSelectOption.apply(this, arguments);
            }
            var activateOption = function(opt) {
                self.setActiveOption($(opt[0]), true, false);
            };
            if (nextActive) {
                var self = this;
                activateOption(self.$dropdown_content.find(nextActive + ":last"));
                activateOption(target);
                activateOption(self.$dropdown_content.find(nextActive + ":first"));
            }
        } else {
            protoSelectOption.apply(this, arguments);
        }
    };
    // Maximize screen space.
    maximizeContent({% if mode == 'editorial_review' %}true{% endif %});
</script>
{% endblock %}
