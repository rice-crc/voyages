{% load i18n %}

<div class="panel panel-primary">
  <div class="panel-heading">{% trans "Publication" %}</div>
  <div class="panel-body">
    <p><input id="skip_backup_check" name="skip_backup" type="checkbox" value="" ><label class="checkbox-inline" for="skip_backup_check">{% trans "Skip full database backup" %}</label></p>
    <button id="publish_all_btn" class="btn btn-primary">{% trans "Publish all" %}</button>
  </div>
</div>

<div class="panel panel-default">
  <div class="panel-heading">{% trans "Downloads" %}</div>
  <div class="panel-body">
    <button class="btn btn-default" id="select_all_downloads">{% trans "Select all" %}</button>
    <button class="btn btn-default" id="clear_all_downloads">{% trans "Clear" %}</button>
    <p><input id="accepted_unpublished_check" name="accepted_unpublished" type="checkbox" checked><label class="checkbox-inline" for="accepted_unpublished">{% trans "Accepted (pending publication)" %}</label></p>
    <p><input id="under_review_check" name="under_review" type="checkbox" checked><label class="checkbox-inline" for="under_review">{% trans "Under review" %}</label></p>
    <p><input id="published_check" name="published" type="checkbox"><label class="checkbox-inline" for="under_review">{% trans "Published" %}</label></p>
    
    <button class="btn btn-primary" id="download_selection">{% trans "Download" %}</button>
  </div>
</div>

<p></p>

<div>
    <span id="last_updated_span"></span>
</div>

<div id="publication_log_pane" class="alert alert-info" style="display: none;">
</div>

<script type="text/javascript">
    var statusChecks = ['accepted_unpublished_check', 'under_review_check', 'published_check'];
    function toggleDownloads(b) {
        for (var i = 0; i < statusChecks.length; ++i) {
            $('#' + statusChecks[i]).prop('checked', b); 
        }
    }
    $('#select_all_downloads').click(function() {
        toggleDownloads(true);
    });
    $('#clear_all_downloads').click(function() {
        toggleDownloads(false);
    });
    $('#download_selection').click(function() {
        var args = [];
        for (var i = 0; i < statusChecks.length; ++i) {
            if ($('#' + statusChecks[i]).prop('checked')) {
                args.push(statusChecks[i] + '=True');
            }
        }
        if (args.length == 0) {
            alert('{% trans "You must select at least one status" %}');
        } else {
            window.location = "{% url 'contribute:download_voyages' %}?" + args.join('&');
        }
    });
    $('#publish_all_btn').click(function() {
        var self = $(this);
        self.prop('disabled', false);
        $.ajax({
            type: "POST",
            url: '/contribute/json_publish_pending',
            data: {skip_backup: document.getElementById('skip_backup_check').checked},
            success: function (response) {
                if (response.result == 'OK') {
                    var log_pane = $('#publication_log_pane');
                    log_pane.append('<p><strong>{% trans "Publication log:" %}</strong></p>');
                    log_pane.show();
                    // Monitor status.
                    var lineCount = 0;
                    var pending = false;
                    var intervalId = 0;
                    intervalId = setInterval(function() {
                        if (pending) return;
                        pending = true;
                        $('#last_updated_span').text('{% trans "Last updated at" %} ' + (new Date()));
                        $.ajax({
                            type: "POST",
                            url: '/contribute/json_retrieve_publication_status',
                            data: { log_file: response.log_file, skip_count: lineCount },
                            success: function (status) {
                                log_pane.append(status.lines);
                                lineCount += parseInt(status.count);
                                if (status.lines.includes('EOF')) {
                                    clearInterval(intervalId);
                                }
                            },
                            complete: function() {
                                pending = false;
                            }
                        })
                    }, 5000)
                } else {
                    alert(response.error);
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert('Error sending decision: ' + textStatus);
            }
        });
    });
</script>