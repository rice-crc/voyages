{% load i18n %}
<link rel="stylesheet" href="{{ STATIC_URL }}maps/css/leaflet.css" />
<link rel="stylesheet" href="{{ STATIC_URL }}maps/css/MarkerCluster.css" />
<link rel="stylesheet" href="{{ STATIC_URL }}maps/css/MarkerCluster.Default.css" />
<div style="display:table-row; height:100%">
    <div id="map" style="width:100%; height:100%; min-height: 500px;"></div>
</div>
<div id="loading" style="position:absolute; left:50%; top:50%; transform: translate(-50%, -50%);">
    <h1>{% trans 'Loading map voyages...' %}</h1>
</div>
<script src="{{ STATIC_URL }}scripts/d3.min.js"></script>
<script src="{{ STATIC_URL }}maps/js/leaflet.js"></script>
<script src="{{ STATIC_URL }}maps/js/leaflet.markercluster.js"></script>
<script src="{{ STATIC_URL }}maps/js/leaflet.polylineDecorator.js"></script>
<script src="{{ STATIC_URL }}maps/js/routeNodes.js"></script>
<script src="{{ STATIC_URL }}maps/js/voyagesMap.js"></script>
<script>
    voyagesMap.init('{{ map_year }}', '{{ STATIC_URL }}maps/', routeNodes, links);
    // SVG + leaflet integration.
    var map = voyagesMap._map;
    var svg = d3.select(map.getPanes().overlayPane).append("svg");
    svg.attr("width", 10000).attr("height", 5000);
    var g = svg.append("g").attr("class", "leaflet-zoom-hide");
    g.append("text")
        .attr("class", "yearLabel")
        .attr("x", 0)
        .attr("y", 0)
        .style("text-anchor", "end")

    function animation(data) {
        // Sort by year, break ties by id.
        var years = d3.nest()
            .key(function(d) { return d.year; })
            .sortKeys(d3.ascending)
            .sortValues(function(a, b) { return a.voyage_id - b.voyage_id; })
            .entries(data);
        var i = 0;
        var yearStep = function() {
            var year = years[i].key;
            var yearData = years[i].values;
            g.selectAll(".yearLabel")
                .text(year);
            var counter = 0;
            g.selectAll(".voyageCircle")
                .data(yearData)
                .enter()
                .append("circle")
                .classed("voyageCircle", true)
                .attr("r", 5)
                .style("fill", "red")
                .transition()
                .duration(2000)
                .attrTween("transform", tween)
                .each("end", function() {
                    d3.select(this).remove();
                });
            if (++i < years.length) {
                window.setTimeout(yearStep, 3000);
            }
        };

        yearStep();
    }

    function tween(d, i, a) {
        var interpolate = d3.geo.interpolate([d.source_lat, d.source_lng], [d.destination_lat, d.destination_lng]);
        return function(t) {
            var x = i / 5;
            if (t > x) {
                t = (t - x)/(1 - x);
            } else {
                t = 0;
            }
            var latlng = interpolate(t);
            var point = map.latLngToLayerPoint(new L.LatLng(latlng[0], latlng[1]));
            return "translate(" + point.x + "," + point.y + ")";
        };
    }

    $( document ).ready(function() {
        var animate = true;
        var onCompleted = function(){
                animate = false;
                $("#loading").hide();
             };
        $.ajax({
             type: "POST",
             url: $("#form").attr('action'),
             data: $("#form").serialize() + '&submitVal=animation_ajax',
             success: animation,
             error: function(jqXHR, textStatus, errorThrown) {
                onCompleted();
                console.log('Failed to load voyages!');
             },
             beforeSend:function(){
                animate = true;
                var target = 0.25;
                $("#loading").show();
                loop = function() {
                    $('#loading').animate({
                        opacity: target,
                    }, 600, 'linear', function() {
                        target = target < 1 ? 1 : 0.25;
                        if (animate) loop();
                    });
                };
                loop();
             },
             complete: onCompleted
        });
    });
</script>